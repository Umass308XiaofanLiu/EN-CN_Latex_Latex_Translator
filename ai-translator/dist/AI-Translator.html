<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Academic Translator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

body { font-family: 'Inter', sans-serif; }
.font-mono { font-family: 'JetBrains Mono', monospace; }

/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

/* KaTeX Display Math */
.katex-display {
    margin: 0.75em 0;
    padding: 0.75em;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    overflow-x: auto;
    text-align: center;
}

/* Prose code style fix */
.prose :where(code):not(:where([class~="not-prose"], [class~="not-prose"] *))::before,
.prose :where(code):not(:where([class~="not-prose"], [class~="not-prose"] *))::after {
    content: "";
}

</style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>
    <script>
// ==================== STATE.JS ====================
// ========================================
// state.js - 全局状态管理
// ========================================

const AppState = {
    // 输入输出状态
    inputText: "",
    originalInputText: "",  // 保存原始粘贴的内容
    translationPairs: [],
    sourceLang: "zh",
    targetLang: "en",

    // 功能开关
    isAutoDetect: true,
    isAutoTranslate: true,
    isAutoSegment: true,  // 自动分段开关：true=逐句分段显示，false=整体翻译
    isLoading: false,
    isEditingMode: true,
    viewMode: 'edit',  // 'edit' | 'preview' | 'original'
    error: null,

    // API配置
    apiProvider: 'gemini', // 'gemini' | 'openai' | 'claude' | 'deepseek' | 'local'
    selectedModel: "gemini-2.5-flash-lite",
    geminiApiKey: "", // Gemini API Key
    openaiApiKey: "", // OpenAI API Key
    claudeApiKey: "", // Claude API Key
    claudeProxyUrl: "", // Claude Proxy URL (Cloudflare Worker)
    deepseekApiKey: "", // DeepSeek API Key
    localBaseUrl: "http://localhost:1234",
    localModels: [],

    // 编辑状态
    activeIndex: null,
    editValues: { src: "", tgt: "" },
    refinePrompt: "",
    isRefining: false,
    customPrompts: { grammar: "", simplify: "" },

    // Toast 提示
    toast: null, // { message: string, type: 'info' | 'success' | 'warning' }

    // AI Insight
    aiInsight: null,
    isInsightLoading: false,

    // 同义词状态
    synonymState: {
        show: false,
        loading: false,
        originalText: "",
        history: [],
        pageIndex: 0,
        position: { x: 0, y: 0 },
        selectionRange: { start: 0, end: 0 },
        field: null,
        contextSentence: ""
    },

    // 历史记录
    globalHistory: [],
    sessionId: Date.now().toString(),
    autoSaveInterval: 5 * 60 * 1000,
    historyLimit: 5,

    // UI菜单状态
    showModelMenu: false,
    showHistoryMenu: false,
    showSaveMenu: false,
    showLocalSettings: false,
    showSettings: false, // 新增：设置弹窗状态
    isConnectingLocal: false,

    // 模型可见性设置
    modelVisibility: {
        'gemini-2.5-flash-lite': true,
        'gemini-3-flash-preview': true,
        'gemini-3-pro-preview': true,
        'gpt-5-nano': true,
        'gpt-5-mini': true,
        'gpt-5.2': true,
        'claude-haiku-4-5-20251001': true,
        'claude-sonnet-4-5-20250929': true,
        'claude-opus-4-5-20251101': true,
        'deepseek-chat': true,
        'deepseek-reasoner': true
    },
    
    // AI Toolbar 设置弹窗状态
    activeSettingsPopup: null, // 'grammar' | 'simplify' | null
    activeSettingsIndex: null,
    activeSettingsSide: null,

    // 控制标志
    isRestoringHistory: false,
    lastTranslatedText: "",

    // Abort Controllers
    mainAbortController: null,
    rowAbortControllers: new Map(),
    regenerateAbortControllers: new Map(),
    regenerateAllAbortController: null,

    // 重新生成状态
    isRegeneratingAll: false,

    // Timers
    debounceTimer: null,
    autoSaveTimer: null
};

// 获取API配置对象
function getApiConfig() {
    return {
        provider: AppState.apiProvider,
        model: AppState.selectedModel,
        localBaseUrl: AppState.localBaseUrl,
        geminiApiKey: AppState.geminiApiKey,
        openaiApiKey: AppState.openaiApiKey,
        claudeApiKey: AppState.claudeApiKey,
        claudeProxyUrl: AppState.claudeProxyUrl,
        deepseekApiKey: AppState.deepseekApiKey
    };
}

// 状态更新并触发UI重渲染
// options: { skipRender: bool, preserveScroll: bool (default true) }
function setState(updates, options = {}) {
    // 兼容旧的 skipRender 布尔参数
    if (typeof options === 'boolean') {
        options = { skipRender: options };
    }
    const { skipRender = false, preserveScroll = true } = options;

    Object.assign(AppState, updates);
    if (!skipRender && typeof renderApp === 'function') {
        // renderApp 现在内置滚动保护，传递 preserveScroll 参数
        renderApp(preserveScroll);
    }
}

// 更新翻译对
function updateTranslationPair(index, updates) {
    const pairs = [...AppState.translationPairs];
    pairs[index] = { ...pairs[index], ...updates };
    setState({ translationPairs: pairs });
}

// 更新同义词状态
function updateSynonymState(updates) {
    Object.assign(AppState.synonymState, updates);
    // 只更新同义词弹窗，不重新渲染整个页面
    renderSynonymPopupOnly();
}

// 只渲染同义词弹窗（不影响其他 DOM）
function renderSynonymPopupOnly() {
    // 移除旧的弹窗
    const oldPopup = document.getElementById('synonymPopup');
    if (oldPopup) oldPopup.remove();
    
    // 如果不需要显示，直接返回
    if (!AppState.synonymState.show) return;
    
    // 创建新的弹窗元素
    const s = AppState.synonymState;
    const currentSynonyms = s.history[s.pageIndex] || [];
    
    const popupHtml = `
        <div id="synonymPopup" style="position:fixed;left:${s.position.x}px;top:${s.position.y + 20}px;transform:translateX(-10%);" class="z-[100] bg-white border border-slate-200 rounded-xl shadow-2xl p-3 min-w-[240px] flex flex-col gap-2">
            <div class="flex items-center justify-between border-b border-slate-100 pb-2">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                    ${Icons.SparklesSmall} Options for "${escapeHtml(s.originalText)}"
                </div>
                <button onclick="updateSynonymState({show:false})" class="text-slate-300 hover:text-slate-500">${Icons.XSmall}</button>
            </div>
            <div class="min-h-[60px] flex flex-col justify-center">
                ${s.loading ? `
                    <div class="flex items-center gap-2 text-xs text-slate-400 py-2 justify-center">
                        <span class="text-indigo-500">${Icons.LoaderSmall}</span> ${s.history.length > 0 ? 'Finding new options...' : 'Finding context matches...'}
                    </div>
                ` : currentSynonyms.length > 0 ? `
                    <div class="flex flex-col gap-1">
                        ${currentSynonyms.map((syn, i) => `
                            <button onclick="applySynonym('${escapeHtml(syn).replace(/'/g, "\\'")}')" class="text-left px-2 py-1.5 rounded hover:bg-indigo-50 text-slate-700 text-xs font-medium hover:text-indigo-700 transition-colors flex items-center gap-2 group">
                                <span class="opacity-0 group-hover:opacity-50 text-indigo-400">${Icons.ArrowRightLeftSmall}</span> ${escapeHtml(syn)}
                            </button>
                        `).join('')}
                    </div>
                ` : `<div class="text-xs text-slate-400 text-center py-2 italic">No context-aware alternatives found.</div>`}
            </div>
            ${(currentSynonyms.length > 0 || s.history.length > 0) ? `
                <div class="flex items-center justify-between border-t border-slate-100 mt-2 pt-2">
                    <button onclick="handleSynonymPageChange(-1)" ${s.pageIndex === 0 || s.loading ? 'disabled' : ''} class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg disabled:opacity-30 transition-all">${Icons.ChevronLeft}</button>
                    <span class="text-[9px] font-mono text-slate-300 select-none">Page ${s.pageIndex + 1}</span>
                    <button onclick="handleSynonymPageChange(1)" ${s.loading ? 'disabled' : ''} class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg disabled:opacity-30 transition-all">${Icons.ChevronRight}</button>
                </div>
            ` : ''}
        </div>
    `;
    
    // 插入到 body
    document.body.insertAdjacentHTML('beforeend', popupHtml);
}

// 默认Prompt常量
const DEFAULT_GRAMMAR_PROMPT = "Check the grammar of the following text and correct it if necessary. Keep the academic tone.";
const DEFAULT_SIMPLIFY_PROMPT = "Rewrite the following sentence to be MORE DIRECT, CONCISE, and SIMPLE to read. Keep the original meaning. STRICTLY PRESERVE all LaTeX math and citations.";

// 语言检测
function detectLanguage(text) {
    const zhMatch = text.match(/[\u4e00-\u9fa5]/g);
    const enMatch = text.match(/[a-zA-Z]/g);
    return (zhMatch?.length || 0) >= (enMatch?.length || 0)
        ? { src: 'zh', tgt: 'en' }
        : { src: 'en', tgt: 'zh' };
}

// LaTeX清理辅助函数
function stripCommand(str, cmd) {
    let result = str;
    while (true) {
        const pattern = new RegExp(`\\\\${cmd}(?:\\*)?\\s*\\{`);
        const match = pattern.exec(result);
        if (!match) break;
        const startIndex = match.index;
        const openBraceIndex = startIndex + match[0].length - 1;
        let depth = 1;
        let endIndex = -1;
        for (let i = openBraceIndex + 1; i < result.length; i++) {
            if (result[i] === '{') depth++;
            else if (result[i] === '}') depth--;
            if (depth === 0) { endIndex = i; break; }
        }
        if (endIndex !== -1) {
            result = result.substring(0, startIndex) + result.substring(endIndex + 1);
        } else { break; }
    }
    return result;
}

function cleanLatex(formula) {
    let clean = formula;
    clean = clean.replace(/(^|[^\\])%.*$/gm, '$1');
    clean = clean.replace(/\\\[\s*(\d+(?:\.\d+)?(?:pt|em|ex|cm|mm|in|pc|px))\s*\]/g, '\\\\[$1]');
    return clean;
}

// 渲染格式化文本（支持Markdown和LaTeX）
function renderFormattedText(text) {
    if (!text || !window.marked || !window.katex) return text || '';
    
    let content = text.replace(/[\u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000\uFEFF]/g, ' ');
    const placeholders = [];
    
    const pushPlaceholder = (regex, type, getFormula) => {
        content = content.replace(regex, (...args) => {
            const match = args[0];
            const id = `%%LATEX_${placeholders.length}%%`;
            let formula = getFormula(...args);
            formula = cleanLatex(formula);
            formula = stripCommand(formula, 'label');
            formula = stripCommand(formula, 'tag');
            try {
                const rendered = window.katex.renderToString(formula, {
                    displayMode: type === 'display',
                    throwOnError: false,
                    trust: true,
                    strict: false,
                    fleqn: false
                });
                placeholders.push({ id, html: rendered });
            } catch (e) {
                placeholders.push({ id, html: match });
            }
            return id;
        });
    };
    
    pushPlaceholder(/\\begin\{([\w\*]+)\}([\s\S]*?)\\end\{\1\}/g, 'display', (match, env, body) => {
        // 将带编号的环境转换为不带编号的版本
        const envMap = {
            'equation': 'equation*',
            'align': 'align*',
            'gather': 'gather*',
            'multline': 'multline*',
            'eqnarray': 'eqnarray*'
        };
        const noNumberEnv = envMap[env] || env;
        return `\\begin{${noNumberEnv}}${body}\\end{${noNumberEnv}}`;
    });
    pushPlaceholder(/\\\[([\s\S]*?)\\\]/g, 'display', (match, p1) => p1);
    pushPlaceholder(/\$\$([\s\S]*?)\$\$/g, 'display', (match, p1) => p1);
    pushPlaceholder(/\\\(([\s\S]*?)\\\)/g, 'inline', (match, p1) => p1);
    pushPlaceholder(/\$([^\$]+?)\$/g, 'inline', (match, p1) => p1);
    
    let html = window.marked.parse(content);
    placeholders.forEach(p => { html = html.replace(p.id, p.html); });
    return html;
}


// ==================== API.JS ====================
// ========================================
// api.js - API服务（Gemini、OpenAI、Claude和本地LLM）
// ========================================

// Gemini API端点
const GEMINI_API_BASE = "https://generativelanguage.googleapis.com/v1beta/models";

// OpenAI API端点
const OPENAI_API_BASE = "https://api.openai.com/v1/chat/completions";

// Claude API端点
const CLAUDE_API_BASE = "https://api.anthropic.com/v1/messages";

// DeepSeek API端点
const DEEPSEEK_API_BASE = "https://api.deepseek.com/chat/completions";

// ============= 本地LLM调用（OpenAI兼容）=============
async function callLocalLLM(baseUrl, model, messages, jsonMode = false, signal = null) {
    const body = {
        model: model || "local-model",
        messages: messages,
        temperature: 0.3,
        max_tokens: 4096
    };

    // LM Studio的JSON模式
    if (jsonMode) {
        body.response_format = { type: "json_object" };
    }

    // 构建endpoint - 直接使用/v1/chat/completions
    const endpoint = `${baseUrl.replace(/\/$/, "")}/v1/chat/completions`;

    try {
        const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
            signal
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices?.[0]?.message?.content || "";
    } catch (error) {
        if (error.name === 'AbortError') throw error;
        throw error;
    }
}

// 获取本地模型列表
async function fetchLocalModels(baseUrl) {
    // 直接使用/v1/models端点，不设置Content-Type（GET请求不需要）
    const endpoint = `${baseUrl.replace(/\/$/, "")}/v1/models`;

    try {
        const response = await fetch(endpoint);

        if (!response.ok) {
            throw new Error(`Failed to fetch models: ${response.status}`);
        }

        const data = await response.json();
        return data.data || [];
    } catch (error) {
        console.error("Fetch models error:", error);
        throw new Error(`无法连接到 ${baseUrl}。请确保 LM Studio 服务器正在运行。`);
    }
}

// 解析JSON响应（处理可能的markdown包裹）
function parseJsonResponse(text) {
    // 检查空响应
    if (!text || text.trim() === '') {
        console.error('parseJsonResponse: Empty response received');
        throw new Error('无法解析 JSON 响应: 收到空响应');
    }

    let clean = text.trim();

    // 移除 markdown 代码块
    if (clean.startsWith('```json')) clean = clean.slice(7);
    else if (clean.startsWith('```')) clean = clean.slice(3);
    if (clean.endsWith('```')) clean = clean.slice(0, -3);
    clean = clean.trim();

    try {
        return JSON.parse(clean);
    } catch (e) {
        // 尝试提取JSON对象
        const match = clean.match(/\{[\s\S]*\}/);
        if (match) {
            try { return JSON.parse(match[0]); } catch (e2) {}
        }
        // 尝试提取JSON数组
        const arrayMatch = clean.match(/\[[\s\S]*\]/);
        if (arrayMatch) {
            try {
                const arr = JSON.parse(arrayMatch[0]);
                return { translations: arr };
            } catch (e3) {}
        }
        console.error('parseJsonResponse failed. Raw response:', text.substring(0, 500));
        throw new Error('无法解析 JSON 响应');
    }
}

// ============= Gemini API调用 =============
async function callGeminiAPI(model, contents, config = {}, apiKey = null, signal = null) {
    if (!apiKey) {
        throw new Error("Gemini API Key not configured. Please add your API key in Settings.");
    }

    const url = `${GEMINI_API_BASE}/${model}:generateContent?key=${apiKey}`;

    const body = {
        contents: [{ parts: [{ text: contents }] }],
        generationConfig: {
            temperature: config.temperature || 0.3
        }
    };

    if (config.systemInstruction) {
        body.systemInstruction = { parts: [{ text: config.systemInstruction }] };
    }

    if (config.responseMimeType) {
        body.generationConfig.responseMimeType = config.responseMimeType;
    }

    if (config.responseSchema) {
        body.generationConfig.responseSchema = config.responseSchema;
    }

    const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
        signal
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(`Gemini API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
}

// ============= OpenAI API调用 =============
// 需要特殊参数处理的新模型（不支持 temperature 和 max_tokens）
const OPENAI_NEW_MODELS = ['gpt-5-nano', 'gpt-5-mini', 'gpt-5.2', 'o1', 'o1-mini', 'o1-preview', 'o3', 'o3-mini'];

function isNewOpenAIModel(model) {
    return OPENAI_NEW_MODELS.some(m => model.startsWith(m));
}

// 根据模型获取合适的 max tokens 限制
function getMaxTokensForModel(model, configMax) {
    if (configMax) return configMax;
    // Nano 模型使用较小的 token 限制
    if (model.includes('nano')) return 2048;
    // Mini 模型使用中等限制
    if (model.includes('mini')) return 4096;
    // 其他模型使用默认值
    return 4096;
}

async function callOpenAIAPI(model, messages, config = {}, apiKey = null, signal = null) {
    if (!apiKey) {
        throw new Error("OpenAI API Key not configured. Please add your API key in Settings.");
    }

    const body = {
        model: model,
        messages: messages
    };

    // 新模型不支持自定义 temperature，只支持默认值 1
    if (!isNewOpenAIModel(model)) {
        body.temperature = config.temperature || 0.3;
    }

    // 新模型使用 max_completion_tokens，旧模型使用 max_tokens
    const maxTokens = getMaxTokensForModel(model, config.max_tokens);
    if (isNewOpenAIModel(model)) {
        body.max_completion_tokens = maxTokens;
    } else {
        body.max_tokens = maxTokens;
    }

    // 如果需要JSON响应（新模型不支持 response_format，通过 prompt 指示返回 JSON）
    if (config.jsonMode && !isNewOpenAIModel(model)) {
        body.response_format = { type: "json_object" };
    }

    const response = await fetch(OPENAI_API_BASE, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(body),
        signal
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(`OpenAI API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || "";
}

// ============= Claude API调用 =============
// Claude 模型 token 限制
function getMaxTokensForClaudeModel(model, configMax) {
    if (configMax) return configMax;
    // Haiku 模型使用较小的 token 限制
    if (model.includes('haiku')) return 4096;
    // Sonnet 和 Opus 使用较大限制
    return 8192;
}

async function callClaudeAPI(model, messages, config = {}, apiKey = null, signal = null, proxyUrl = null) {
    if (!apiKey) {
        throw new Error("Claude API Key not configured. Please add your API key in Settings.");
    }

    if (!proxyUrl) {
        throw new Error("Claude Proxy URL not configured. Please add your Cloudflare Worker proxy URL in Settings.");
    }

    // 提取 system message（Claude 使用单独的 system 参数）
    let systemPrompt = null;
    const userMessages = [];

    for (const msg of messages) {
        if (msg.role === 'system') {
            systemPrompt = msg.content;
        } else {
            userMessages.push({
                role: msg.role,
                content: msg.content
            });
        }
    }

    const body = {
        model: model,
        max_tokens: getMaxTokensForClaudeModel(model, config.max_tokens),
        messages: userMessages
    };

    // 添加 system prompt（如果有）
    if (systemPrompt) {
        body.system = systemPrompt;
    }

    // Claude 支持 temperature 参数
    if (config.temperature !== undefined) {
        body.temperature = config.temperature;
    } else {
        body.temperature = 0.3;
    }

    // 使用代理 URL 而不是直接调用 Claude API
    const endpoint = proxyUrl.replace(/\/$/, "");

    const response = await fetch(endpoint, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify(body),
        signal
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(`Claude API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    // Claude 返回格式: { content: [{ type: "text", text: "..." }] }
    return data.content?.[0]?.text || "";
}

// ============= DeepSeek API调用 =============
// DeepSeek-V3.2 模型：deepseek-chat (非思考模式), deepseek-reasoner (思考模式)
const DEEPSEEK_THINKING_MODELS = ['deepseek-reasoner'];

function isDeepSeekThinkingModel(model) {
    return DEEPSEEK_THINKING_MODELS.some(m => model.startsWith(m));
}

async function callDeepSeekAPI(model, messages, config = {}, apiKey = null, signal = null) {
    if (!apiKey) {
        throw new Error("DeepSeek API Key not configured. Please add your API key in Settings.");
    }

    const body = {
        model: model,
        messages: messages
    };

    // 思考模式模型 (deepseek-reasoner) 不支持自定义 temperature
    if (!isDeepSeekThinkingModel(model)) {
        body.temperature = config.temperature || 0.3;
    }

    // 设置 max_tokens
    body.max_tokens = config.max_tokens || 4096;

    // 如果需要JSON响应
    if (config.jsonMode && !isDeepSeekThinkingModel(model)) {
        body.response_format = { type: "json_object" };
    }

    const response = await fetch(DEEPSEEK_API_BASE, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(body),
        signal
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(`DeepSeek API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || "";
}

// ============= 批量翻译 =============
async function translateBulk(text, srcLang, tgtLang, config, signal = null, autoSegment = true) {
    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");

    const srcName = srcLang === 'zh' ? 'Chinese' : 'English';
    const tgtName = tgtLang === 'zh' ? 'Chinese' : 'English';

    // 根据 autoSegment 选项选择不同的 prompt
    const systemPrompt = autoSegment
        ? `You are a professional academic translator.
1. Split input into logical sentences/segments.
2. Translate ${srcName} to ${tgtName}.
3. Keep LaTeX math/citations intact.
4. You MUST return ONLY valid JSON: {"translations": [{"src": "Original 1", "tgt": "Translated 1"}]}
5. Do NOT include any text before or after the JSON.`
        : `You are a professional academic translator.
1. Translate the ENTIRE input as a SINGLE unit from ${srcName} to ${tgtName}.
2. Do NOT split into sentences or segments - keep as one complete translation.
3. Keep LaTeX math/citations intact.
4. Preserve the original paragraph structure and line breaks.
5. You MUST return ONLY valid JSON: {"translations": [{"src": "The entire original text", "tgt": "The entire translated text"}]}
6. Do NOT include any text before or after the JSON.`;

    if (config.provider === 'local') {
        const response = await callLocalLLM(
            config.localBaseUrl,
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: text }
            ],
            false, // 不使用json_mode，让模型自由返回
            signal
        );
        return parseJsonResponse(response);
    }

    // OpenAI Path
    if (config.provider === 'openai') {
        const response = await callOpenAIAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: text }
            ],
            { jsonMode: true },
            config.openaiApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return parseJsonResponse(response);
    }

    // Claude Path
    if (config.provider === 'claude') {
        const response = await callClaudeAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: text }
            ],
            { temperature: 0.3 },
            config.claudeApiKey,
            signal,
            config.claudeProxyUrl
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return parseJsonResponse(response);
    }

    // DeepSeek Path
    if (config.provider === 'deepseek') {
        const response = await callDeepSeekAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: text }
            ],
            { jsonMode: true },
            config.deepseekApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return parseJsonResponse(response);
    }

    // Gemini Path
    const responseSchema = {
        type: "OBJECT",
        properties: {
            translations: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        src: { type: "STRING" },
                        tgt: { type: "STRING" }
                    },
                    required: ["src", "tgt"]
                }
            }
        },
        required: ["translations"]
    };

    const response = await callGeminiAPI(config.model, text, {
        systemInstruction: systemPrompt,
        responseMimeType: "application/json",
        responseSchema: responseSchema
    }, config.geminiApiKey, signal);

    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
    return JSON.parse(response || "{}");
}

// ============= 句子精炼 =============
async function refineSentence(text, lang, type, config, instruction = null, signal = null) {
    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");

    let prompt = "";

    if (type === "grammar") {
        const baseInst = instruction || `${DEFAULT_GRAMMAR_PROMPT} (Language: ${lang === 'zh' ? 'Chinese' : 'English'})`;
        prompt = `${baseInst}

IMPORTANT RULES:
1. If there are grammar errors, return ONLY the corrected sentence.
2. If the text is already grammatically correct, return exactly: [NO_CHANGES]
3. Do NOT explain or describe what you did. Return ONLY the corrected text or [NO_CHANGES].

Text: "${text}"`;
    } else if (type === "simplify") {
        const baseInst = instruction || `${DEFAULT_SIMPLIFY_PROMPT} (Language: ${lang === 'zh' ? 'Chinese' : 'English'})
CRITICAL RULES:
1. Use common vocabulary.
2. STRICTLY PRESERVE all LaTeX math (e.g., $x_i$, \\xi_k), citations (e.g., [1]), and serial numbers (e.g., 1., (a)) exactly as they are.`;
        prompt = `${baseInst}\n3. Return ONLY the rewritten sentence.\nOriginal Text: "${text}"`;
    } else if (type === "custom") {
        prompt = `Rewrite the following ${lang === 'zh' ? 'Chinese' : 'English'} sentence based on this instruction: "${instruction}". Return ONLY the rewritten sentence.\n\nText: "${text}"`;
    }

    if (config.provider === 'local') {
        return await callLocalLLM(
            config.localBaseUrl,
            config.model,
            [{ role: "user", content: prompt }],
            false,
            signal
        );
    }

    // OpenAI Path
    if (config.provider === 'openai') {
        const response = await callOpenAIAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { temperature: 0.3 },
            config.openaiApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return response?.trim() || text;
    }

    // Claude Path
    if (config.provider === 'claude') {
        const response = await callClaudeAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { temperature: 0.3 },
            config.claudeApiKey,
            signal,
            config.claudeProxyUrl
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return response?.trim() || text;
    }

    // DeepSeek Path
    if (config.provider === 'deepseek') {
        const response = await callDeepSeekAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { temperature: 0.3 },
            config.deepseekApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        return response?.trim() || text;
    }

    // Gemini Path
    const response = await callGeminiAPI(config.model, prompt, { temperature: 0.3 }, config.geminiApiKey, signal);
    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
    return response?.trim() || text;
}

// ============= 智能更新 =============
async function getSmartUpdate(prompt, config, signal = null) {
    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");

    const systemPrompt = "You update translations intelligently. Return valid JSON only.";

    if (config.provider === 'local') {
        const response = await callLocalLLM(
            config.localBaseUrl,
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: prompt + "\n\nRETURN JSON: {\"text\": \"...\"}" }
            ],
            false, // 不使用json_mode
            signal
        );
        try {
            const data = parseJsonResponse(response);
            return data.text || "";
        } catch (e) { return ""; }
    }

    // OpenAI Path
    if (config.provider === 'openai') {
        const response = await callOpenAIAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: prompt + "\n\nRETURN JSON: {\"text\": \"...\"}" }
            ],
            { jsonMode: true },
            config.openaiApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        try {
            const data = parseJsonResponse(response);
            return data.text || "";
        } catch (e) { return ""; }
    }

    // Claude Path
    if (config.provider === 'claude') {
        const response = await callClaudeAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: prompt + "\n\nRETURN JSON: {\"text\": \"...\"}" }
            ],
            { temperature: 0.3 },
            config.claudeApiKey,
            signal,
            config.claudeProxyUrl
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        try {
            const data = parseJsonResponse(response);
            return data.text || "";
        } catch (e) { return ""; }
    }

    // DeepSeek Path
    if (config.provider === 'deepseek') {
        const response = await callDeepSeekAPI(
            config.model,
            [
                { role: "system", content: systemPrompt },
                { role: "user", content: prompt + "\n\nRETURN JSON: {\"text\": \"...\"}" }
            ],
            { jsonMode: true },
            config.deepseekApiKey,
            signal
        );
        if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
        try {
            const data = parseJsonResponse(response);
            return data.text || "";
        } catch (e) { return ""; }
    }

    // Gemini Path
    const responseSchema = {
        type: "OBJECT",
        properties: {
            text: { type: "STRING" }
        },
        required: ["text"]
    };

    const response = await callGeminiAPI(config.model, prompt, {
        responseMimeType: "application/json",
        responseSchema: responseSchema
    }, config.geminiApiKey, signal);

    if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
    const data = JSON.parse(response || "{}");
    return data.text || "";
}

// ============= 获取同义词 =============
async function getSynonyms(sentence, selectedText, lang, config, avoidList = []) {
    const avoidInstruction = avoidList.length > 0
        ? `IMPORTANT: Do NOT include any of the following words/phrases in your output: ${JSON.stringify(avoidList)}. Find DIFFERENT alternatives.`
        : "";

    const prompt = `Context Sentence: "${sentence}"
Selected Text: "${selectedText}"
Language: ${lang === 'zh' ? 'Chinese' : 'English'}

Task: Provide 4-5 distinct, academic-style alternatives for the "Selected Text".
1. If "Selected Text" is a single word, provide synonyms.
2. If "Selected Text" is a phrase or clause, provide rephrased versions that convey the SAME meaning and function within the context.
3. The alternatives must fit grammatically into the "Context Sentence" if substituted.
4. SORT your result list by Semantic Proximity (closest meaning first, then slightly more varied).
5. ${avoidInstruction}

Return JSON: { "alternatives": ["option1", "option2", "option3", "option4"] }`;

    if (config.provider === 'local') {
        const response = await callLocalLLM(
            config.localBaseUrl,
            config.model,
            [{ role: "user", content: prompt }],
            false // 不使用json_mode
        );
        try {
            const data = parseJsonResponse(response);
            return data.alternatives || [];
        } catch (e) { return []; }
    }

    // OpenAI Path
    if (config.provider === 'openai') {
        const response = await callOpenAIAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { jsonMode: true },
            config.openaiApiKey
        );
        try {
            const data = parseJsonResponse(response);
            return data.alternatives || [];
        } catch (e) { return []; }
    }

    // Claude Path
    if (config.provider === 'claude') {
        const response = await callClaudeAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { temperature: 0.3 },
            config.claudeApiKey,
            null,
            config.claudeProxyUrl
        );
        try {
            const data = parseJsonResponse(response);
            return data.alternatives || [];
        } catch (e) { return []; }
    }

    // DeepSeek Path
    if (config.provider === 'deepseek') {
        const response = await callDeepSeekAPI(
            config.model,
            [{ role: "user", content: prompt }],
            { jsonMode: true },
            config.deepseekApiKey
        );
        try {
            const data = parseJsonResponse(response);
            return data.alternatives || [];
        } catch (e) { return []; }
    }

    // Gemini Path
    const responseSchema = {
        type: "OBJECT",
        properties: {
            alternatives: {
                type: "ARRAY",
                items: { type: "STRING" }
            }
        },
        required: ["alternatives"]
    };

    const response = await callGeminiAPI(config.model, prompt, {
        responseMimeType: "application/json",
        responseSchema: responseSchema
    }, config.geminiApiKey);

    const data = JSON.parse(response || "{}");
    return data.alternatives || [];
}

// ============= 文本摘要 =============
async function summarizeText(text, config) {
    const prompt = `总结:\n${text}`;

    if (config.provider === 'local') {
        return await callLocalLLM(
            config.localBaseUrl,
            config.model,
            [{ role: "user", content: prompt }]
        );
    }

    // OpenAI Path
    if (config.provider === 'openai') {
        const response = await callOpenAIAPI(
            config.model,
            [{ role: "user", content: prompt }],
            {},
            config.openaiApiKey
        );
        return response || "";
    }

    // Claude Path
    if (config.provider === 'claude') {
        const response = await callClaudeAPI(
            config.model,
            [{ role: "user", content: prompt }],
            {},
            config.claudeApiKey,
            null,
            config.claudeProxyUrl
        );
        return response || "";
    }

    // DeepSeek Path
    if (config.provider === 'deepseek') {
        const response = await callDeepSeekAPI(
            config.model,
            [{ role: "user", content: prompt }],
            {},
            config.deepseekApiKey
        );
        return response || "";
    }

    // Gemini Path
    const response = await callGeminiAPI(config.model, prompt, {}, config.geminiApiKey);
    return response || "";
}


// ==================== TRANSLATE.JS ====================
// ========================================
// translate.js - 翻译核心逻辑
// ========================================

// ============= 翻译相关函数 =============

// 执行翻译
async function handleTranslate() {
    // 停止功能
    if (AppState.isLoading && AppState.mainAbortController) {
        AppState.mainAbortController.abort();
        setState({ isLoading: false });
        return;
    }

    if (!AppState.inputText.trim()) return;

    // 检查输入是否变化：如果已有翻译结果且输入未改变，则不执行翻译
    // 用户应使用重新生成按钮来重新翻译
    if (AppState.translationPairs.length > 0 && AppState.inputText === AppState.lastTranslatedText) {
        return;
    }

    // 保存原始输入内容（首次翻译时）
    if (!AppState.originalInputText || AppState.translationPairs.length === 0) {
        AppState.originalInputText = AppState.inputText;
    }

    // 同步基线以防止重复自动翻译
    AppState.lastTranslatedText = AppState.inputText;

    let srcLang, tgtLang;
    if (AppState.isAutoDetect) {
        const detected = detectLanguage(AppState.inputText);
        srcLang = detected.src;
        tgtLang = detected.tgt;
        setState({ sourceLang: srcLang, targetLang: tgtLang }, true);
    } else {
        srcLang = AppState.sourceLang;
        tgtLang = AppState.targetLang;
    }

    setState({ isLoading: true, error: null, aiInsight: null });

    // 初始化AbortController
    const controller = new AbortController();
    AppState.mainAbortController = controller;

    try {
        const config = getApiConfig();
        const result = await translateBulk(AppState.inputText, srcLang, tgtLang, config, controller.signal, AppState.isAutoSegment);

        if (result?.translations) {
            const pairs = result.translations.map(t => ({
                src: t.src,
                tgt: t.tgt,
                history: [{ src: t.src, tgt: t.tgt }],
                historyIndex: 0,
                isUpdating: false,
                isRegenerating: false
            }));
            setState({ translationPairs: pairs, isEditingMode: false, viewMode: 'preview', isLoading: false });
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            setState({ error: err.message || "AI Translation failed. Please try again." });
            console.error(err);
        }
    } finally {
        // 确保 isLoading 状态被正确设置并触发重新渲染
        AppState.mainAbortController = null;
        if (AppState.isLoading) {
            setState({ isLoading: false });
        }
    }
}

// 保存行更新
async function saveRowUpdate(index, manualValues = null) {
    const original = AppState.translationPairs[index];
    const currentSrc = manualValues ? manualValues.src : AppState.editValues.src;
    const currentTgt = manualValues ? manualValues.tgt : AppState.editValues.tgt;

    // 检查是否需要取消现有更新
    if (original.isUpdating) {
        const controller = AppState.rowAbortControllers.get(index);
        if (controller) {
            controller.abort();
            AppState.rowAbortControllers.delete(index);
            updateTranslationPair(index, { isUpdating: false });
            return;
        }
    }

    // 严格检查：如果完全没有变化，立即退出
    if (currentSrc === original.src && currentTgt === original.tgt) {
        return;
    }

    const srcChanged = currentSrc !== original.src;
    const tgtChanged = currentTgt !== original.tgt;
    const needsAiUpdate = (srcChanged && !tgtChanged) || (tgtChanged && !srcChanged);

    updateTranslationPair(index, {
        src: currentSrc,
        tgt: currentTgt,
        isUpdating: needsAiUpdate
    });

    let prompt = "";
    let updateField = null;

    if (srcChanged && !tgtChanged) {
        prompt = `You are updating a translation. Original Source: "${original.src}". Current Translation: "${original.tgt}". New Source: "${currentSrc}". Task: Translate the "New Source" to ${AppState.targetLang === 'zh' ? 'Chinese' : 'English'}. Constraint: Keep the style and vocabulary of the "Current Translation" where possible. Return JSON: {"text": "..."}`;
        updateField = "tgt";
    } else if (tgtChanged && !srcChanged) {
        prompt = `You are aligning a source text to match a modified translation. Original Source: "${original.src}". Original Translation: "${original.tgt}". New Translation: "${currentTgt}". Task: Update the "Original Source" in ${AppState.sourceLang === 'zh' ? 'Chinese' : 'English'} so that it matches the meaning AND TONE of the "New Translation". Return JSON: {"text": "..."}`;
        updateField = "src";
    }

    if (!updateField) {
        addHistory(index, currentSrc, currentTgt);
        return;
    }

    // AI更新（支持中止）
    const controller = new AbortController();
    AppState.rowAbortControllers.set(index, controller);

    try {
        const config = getApiConfig();
        const resultText = await getSmartUpdate(prompt, config, controller.signal);
        const finalSrc = updateField === 'src' ? resultText : currentSrc;
        const finalTgt = updateField === 'tgt' ? resultText : currentTgt;
        addHistory(index, finalSrc, finalTgt);
        // editValues 已在 addHistory 中同步更新
    } catch (e) {
        if (e.name !== 'AbortError') {
            console.error("Smart update failed", e);
            addHistory(index, currentSrc, currentTgt);
            setState({ error: e.message || "Smart update failed" });
        }
    } finally {
        AppState.rowAbortControllers.delete(index);
    }
}

// 添加历史记录
function addHistory(index, s, t) {
    const pairs = [...AppState.translationPairs];
    const newHistory = [...pairs[index].history, { src: s, tgt: t }];
    pairs[index] = {
        ...pairs[index],
        src: s,
        tgt: t,
        history: newHistory,
        historyIndex: newHistory.length - 1,
        isUpdating: false
    };
    
    // 同时更新 editValues 以保持同步，避免状态不一致
    if (AppState.activeIndex === index) {
        AppState.editValues = { src: s, tgt: t };
    }
    
    setState({ translationPairs: pairs });
}

// 历史导航
function handleHistoryNav(index, delta) {
    const item = AppState.translationPairs[index];
    const newIdx = item.historyIndex + delta;
    if (newIdx >= 0 && newIdx < item.history.length) {
        const historic = item.history[newIdx];
        const pairs = [...AppState.translationPairs];
        pairs[index] = { ...item, src: historic.src, tgt: historic.tgt, historyIndex: newIdx };
        
        // 同时更新 editValues 以保持同步
        if (AppState.activeIndex === index) {
            AppState.editValues = { src: historic.src, tgt: historic.tgt };
        }
        
        setState({ translationPairs: pairs });
    }
}

// AI精炼
async function handleAiRefine(index, field, type) {
    if (AppState.isRefining) return;
    setState({ isRefining: true });

    const text = field === 'src' ? AppState.editValues.src : AppState.editValues.tgt;
    const lang = field === 'src' ? AppState.sourceLang : AppState.targetLang;

    let instruction = undefined;
    if (type === 'grammar') instruction = AppState.customPrompts.grammar;
    if (type === 'simplify') instruction = AppState.customPrompts.simplify;

    try {
        const config = getApiConfig();
        const customInst = type === 'custom' ? AppState.refinePrompt : instruction;
        const refined = await refineSentence(text, lang, type, config, customInst);

        if (refined) {
            // 检测 AI 返回的 "无需修改" 标记或常见的无修改响应
            const noChangePatterns = [
                '[NO_CHANGES]',
                'already grammatically correct',
                'no grammar errors',
                'no changes needed',
                'text is correct',
                '没有语法错误',
                '语法正确',
                '无需修改'
            ];

            const isNoChange = noChangePatterns.some(pattern =>
                refined.toLowerCase().includes(pattern.toLowerCase())
            ) || refined.trim() === text.trim();

            if (isNoChange) {
                // 显示提示框而不是替换文本
                showToast(type === 'grammar' ? '✓ No grammar errors found' : '✓ Text is already simple enough', 'success');
            } else {
                const newVals = { ...AppState.editValues, [field]: refined };
                setState({ editValues: newVals }, true);
                await saveRowUpdate(index, newVals);
            }
        }
    } catch (e) {
        setState({ error: e.message || "Refinement failed" });
    } finally {
        setState({ isRefining: false });
        if (type === 'custom') setState({ refinePrompt: "" }, true);
    }
}

// 显示 Toast 提示
function showToast(message, type = 'info') {
    setState({ toast: { message, type } });
    setTimeout(() => {
        setState({ toast: null });
    }, 3000);
}

// 处理文本选择（同义词）
async function handleTextSelect(event, field, index) {
    const target = event.target;
    let start = target.selectionStart;
    let end = target.selectionEnd;

    if (start === end) return;

    const text = target.value;
    let selectedText = text.substring(start, end);

    // 去除尾随空格（浏览器双击选词常常会包含尾随空格）
    const trimmedEnd = selectedText.replace(/\s+$/, '');
    if (trimmedEnd.length < selectedText.length) {
        end = start + trimmedEnd.length;
        selectedText = trimmedEnd;
        // 更新浏览器的选中范围
        target.setSelectionRange(start, end);
    }
    
    // 去除前导空格
    const trimmedStart = selectedText.replace(/^\s+/, '');
    if (trimmedStart.length < selectedText.length) {
        start = end - trimmedStart.length;
        selectedText = trimmedStart;
        target.setSelectionRange(start, end);
    }

    if (!selectedText || selectedText.length < 1 || /^\s*$/.test(selectedText)) return;

    updateSynonymState({
        show: true,
        loading: true,
        originalText: selectedText,
        history: [],
        pageIndex: 0,
        position: { x: event.clientX, y: event.clientY },
        selectionRange: { start, end },
        field,
        contextSentence: text
    });

    try {
        const lang = field === 'src' ? AppState.sourceLang : AppState.targetLang;
        const config = getApiConfig();
        const alternatives = await getSynonyms(text, selectedText, lang, config, []);

        updateSynonymState({
            loading: false,
            history: [alternatives]
        });
    } catch (err) {
        console.error(err);
        updateSynonymState({ show: false });
    }
}

// 同义词翻页
async function handleSynonymPageChange(direction) {
    const { pageIndex, history, contextSentence, originalText, field } = AppState.synonymState;

    if (direction === -1) {
        if (pageIndex > 0) {
            updateSynonymState({ pageIndex: pageIndex - 1 });
        }
    } else {
        if (pageIndex < history.length - 1) {
            updateSynonymState({ pageIndex: pageIndex + 1 });
        } else {
            if (!field) return;
            const lang = field === 'src' ? AppState.sourceLang : AppState.targetLang;

            updateSynonymState({ loading: true });

            try {
                const avoidList = history.flat();
                const config = getApiConfig();
                const newAlternatives = await getSynonyms(contextSentence, originalText, lang, config, avoidList);

                updateSynonymState({
                    loading: false,
                    history: [...history, newAlternatives],
                    pageIndex: pageIndex + 1
                });
            } catch (e) {
                updateSynonymState({ loading: false });
            }
        }
    }
}

// 应用同义词
function applySynonym(synonym) {
    if (!AppState.synonymState.field || AppState.activeIndex === null) return;

    const field = AppState.synonymState.field;
    const currentText = AppState.editValues[field];
    const { start, end } = AppState.synonymState.selectionRange;

    const newText = currentText.substring(0, start) + synonym + currentText.substring(end);

    // 更新状态
    AppState.editValues[field] = newText;
    
    // 直接更新 textarea 的值（避免重新渲染）
    const textarea = document.getElementById(`editTextarea_${field}_${AppState.activeIndex}`);
    if (textarea) {
        textarea.value = newText;
        // 设置光标位置到替换文本末尾
        const newCursorPos = start + synonym.length;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
    }
    
    // 关闭弹窗
    updateSynonymState({ show: false });
}

// 处理摘要
async function handleSummary() {
    if (AppState.translationPairs.length === 0) return;
    
    setState({ isInsightLoading: true, aiInsight: { type: 'summary', title: 'Loading...', content: '' } });
    
    try {
        const fullText = AppState.translationPairs.map(p => p.src).join('\n');
        const config = getApiConfig();
        const summary = await summarizeText(fullText, config);
        setState({ aiInsight: { type: 'summary', title: '学术摘要', content: summary } });
    } catch (e) {
        setState({ aiInsight: null, error: e.message || "Failed to generate summary" });
    } finally {
        setState({ isInsightLoading: false });
    }
}

// 连接本地服务器
async function handleConnectLocal() {
    setState({ isConnectingLocal: true, error: null });
    
    try {
        const models = await fetchLocalModels(AppState.localBaseUrl);
        setState({ localModels: models });
        
        let selectedModelId;
        if (models.length > 0) {
            selectedModelId = models[0].id;
            setState({ apiProvider: 'local', selectedModel: selectedModelId });
        } else {
            selectedModelId = 'local-model';
            setState({ apiProvider: 'local', selectedModel: selectedModelId });
        }
        
        // 保存到 localStorage
        try {
            localStorage.setItem('apiProvider', 'local');
            localStorage.setItem('selectedModel', selectedModelId);
            localStorage.setItem('localBaseUrl', AppState.localBaseUrl);
        } catch (e) {}

        // 显示按钮反馈动画
        if (AppState._connectButtonElement) {
            showConnectButtonFeedback(AppState._connectButtonElement, models.length);
            AppState._connectButtonElement = null;
        }
        setState({ showLocalSettings: false });
    } catch (e) {
        setState({ error: e.message });
    } finally {
        setState({ isConnectingLocal: false });
    }
}

// ============= 全局历史管理 =============

function addToGlobalHistory(pairs, sid) {
    if (pairs.length === 0) return;

    let history = [...AppState.globalHistory];
    const existingIndex = history.findIndex(item => item.id === sid);
    const updatedPairs = JSON.parse(JSON.stringify(pairs));

    if (existingIndex !== -1) {
        history[existingIndex] = {
            ...history[existingIndex],
            timestamp: Date.now(),
            pairs: updatedPairs
        };
        const item = history.splice(existingIndex, 1)[0];
        history.unshift(item);
    } else {
        const newItem = {
            id: sid,
            timestamp: Date.now(),
            pairs: updatedPairs
        };
        history = [newItem, ...history];
    }

    setState({ globalHistory: history.slice(0, AppState.historyLimit) });
}

function restoreGlobalHistory(item) {
    if (AppState.translationPairs.length > 0) {
        addToGlobalHistory(AppState.translationPairs, AppState.sessionId);
    }

    AppState.isRestoringHistory = true;

    setState({
        sessionId: item.id,
        translationPairs: item.pairs,
        inputText: item.pairs.map(p => p.src).join('\n'),
        isEditingMode: false,
        showHistoryMenu: false
    });

    setTimeout(() => {
        AppState.isRestoringHistory = false;
    }, 500);
}

// ============= 事件处理 =============

function handleInputChange(value) {
    // 如果正在恢复历史，跳过
    if (AppState.isRestoringHistory) {
        return;
    }

    // 如果从空变为有内容，创建新会话
    if (AppState.inputText === "" && value !== "") {
        if (AppState.translationPairs.length === 0) {
            AppState.sessionId = Date.now().toString();
        }
    }

    AppState.inputText = value;
    AppState.isEditingMode = true;
    AppState.isRestoringHistory = false;

    // 如果输入为空，清空状态并重新渲染（需要隐藏翻译结果）
    if (!value.trim()) {
        AppState.translationPairs = [];
        renderApp();
        return;
    }

    // 自动翻译防抖
    if (AppState.isAutoTranslate) {
        if (AppState.debounceTimer) {
            clearTimeout(AppState.debounceTimer);
        }
        AppState.debounceTimer = setTimeout(() => {
            if (AppState.isEditingMode && AppState.inputText !== AppState.lastTranslatedText) {
                handleTranslate();
            }
        }, 1500);
    }

    // 不再调用 renderApp()，避免焦点丢失
    // 输入时 textarea 的值已经被浏览器更新，无需重新渲染
}

function handleRowClick(index, clickedSide = null) {
    if (AppState.activeIndex !== null && AppState.activeIndex !== index) {
        saveRowUpdate(AppState.activeIndex);
    }

    // 在 setState 之前保存滚动位置和点击行的位置信息
    const sourceContainer = document.querySelector('section:first-of-type .overflow-y-auto');
    const targetContainer = document.querySelector('section:last-of-type .overflow-y-auto');

    let savedScrollInfo = null;
    if (sourceContainer && targetContainer && clickedSide) {
        const clickedContainer = clickedSide === 'src' ? sourceContainer : targetContainer;
        const clickedRow = clickedContainer.querySelector(`[data-idx="${index}"]`);

        if (clickedRow) {
            const containerRect = clickedContainer.getBoundingClientRect();
            const rowRect = clickedRow.getBoundingClientRect();
            savedScrollInfo = {
                clickedSide: clickedSide,
                clickedScrollTop: clickedContainer.scrollTop,
                rowRelativeTop: rowRect.top - containerRect.top, // 行相对于容器顶部的位置
                index: index
            };
        }
    }

    // 使用 preserveScroll: false，因为我们有自己的滚动同步逻辑
    setState({
        activeIndex: index,
        editValues: {
            src: AppState.translationPairs[index].src,
            tgt: AppState.translationPairs[index].tgt
        },
        isEditingMode: false
    }, { preserveScroll: false });

    // 滚动同步：恢复点击侧的滚动位置，并同步另一侧
    if (savedScrollInfo) {
        requestAnimationFrame(() => {
            syncScrollAfterRender(savedScrollInfo);
        });
    }
}

// 渲染后恢复滚动位置并同步
function syncScrollAfterRender(scrollInfo) {
    const sourceContainer = document.querySelector('section:first-of-type .overflow-y-auto');
    const targetContainer = document.querySelector('section:last-of-type .overflow-y-auto');

    if (!sourceContainer || !targetContainer) return;

    const { clickedSide, clickedScrollTop, rowRelativeTop, index } = scrollInfo;

    const clickedContainer = clickedSide === 'src' ? sourceContainer : targetContainer;
    const otherContainer = clickedSide === 'src' ? targetContainer : sourceContainer;

    // 1. 恢复点击侧的滚动位置
    clickedContainer.scrollTop = clickedScrollTop;

    // 2. 找到另一侧对应的行，并滚动到相同的相对位置
    const otherRow = otherContainer.querySelector(`[data-idx="${index}"]`);
    if (otherRow) {
        // 计算另一侧需要滚动到的位置，使对应行在相同的相对位置
        const otherRowOffsetTop = otherRow.offsetTop;
        otherContainer.scrollTop = otherRowOffsetTop - rowRelativeTop;
    }
}

// 全局点击处理 - 点击空白区域退出编辑模式
function handleGlobalClick(event) {
    // 如果没有正在编辑的句子，直接返回
    if (AppState.activeIndex === null) return;

    // 检查点击的目标是否在句子行内
    const clickedRow = event.target.closest('[data-idx]');
    if (clickedRow) return;

    // 检查是否点击了模态框、菜单、按钮等交互元素
    const clickedModal = event.target.closest('.fixed.inset-0'); // 模态框
    const clickedButton = event.target.closest('button');
    const clickedInput = event.target.closest('input, textarea, select');
    const clickedDropdown = event.target.closest('[onclick*="toggle"], [onclick*="Menu"], [onclick*="Settings"]');

    // 如果点击了这些元素，不退出编辑模式
    if (clickedModal || clickedButton || clickedInput || clickedDropdown) return;

    // 点击了空白区域，保存当前编辑并退出编辑模式
    saveRowUpdate(AppState.activeIndex);
    setState({
        activeIndex: null,
        editValues: { src: '', tgt: '' }
    });
}

// 向后兼容的局部处理函数
function handleBlankAreaClick(event) {
    handleGlobalClick(event);
}

function handleManualSave() {
    if (AppState.translationPairs.length > 0) {
        addToGlobalHistory(AppState.translationPairs, AppState.sessionId);
    }
}

function handleClear() {
    if (AppState.mainAbortController) {
        AppState.mainAbortController.abort();
    }

    if (AppState.translationPairs.length > 0) {
        addToGlobalHistory(AppState.translationPairs, AppState.sessionId);
    }

    AppState.isRestoringHistory = true;

    setState({
        inputText: "",
        originalInputText: "",
        translationPairs: [],
        activeIndex: null,
        isEditingMode: true,
        viewMode: 'edit',
        isLoading: false,
        sessionId: Date.now().toString(),
        error: null
    });

    updateSynonymState({ show: false });

    setTimeout(() => {
        AppState.isRestoringHistory = false;
    }, 100);

    AppState.lastTranslatedText = "";
}

function toggleEditMode() {
    if (AppState.isEditingMode) {
        setState({ isEditingMode: false });
    } else {
        const reconstructed = AppState.translationPairs.map(p => p.src).join('\n');
        setState({ inputText: reconstructed, isEditingMode: true });
        AppState.lastTranslatedText = reconstructed;
    }
}

// ============= 重新生成所有翻译 =============
async function handleRegenerateAll() {
    // 如果没有翻译对，直接返回
    if (AppState.translationPairs.length === 0) return;

    // 如果正在重新生成，则取消
    if (AppState.isRegeneratingAll) {
        if (AppState.regenerateAllAbortController) {
            AppState.regenerateAllAbortController.abort();
            AppState.regenerateAllAbortController = null;
        }
        setState({ isRegeneratingAll: false });
        return;
    }

    // 初始化 AbortController
    const controller = new AbortController();
    AppState.regenerateAllAbortController = controller;

    setState({ isRegeneratingAll: true, error: null });

    try {
        const config = getApiConfig();
        // 使用原始输入内容重新翻译（不是按句拼接的）
        const originalText = AppState.originalInputText || AppState.inputText;

        // 重新翻译所有内容
        const result = await translateBulk(originalText, AppState.sourceLang, AppState.targetLang, config, controller.signal, AppState.isAutoSegment);

        if (result?.translations) {
            // 重新生成时，每个翻译对重置历史记录（不累加每句的历史）
            const pairs = result.translations.map((t) => ({
                src: t.src,
                tgt: t.tgt,
                history: [{ src: t.src, tgt: t.tgt }],
                historyIndex: 0,
                isUpdating: false,
                isRegenerating: false
            }));
            setState({ translationPairs: pairs, viewMode: 'preview', activeIndex: null });
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            setState({ error: err.message || "重新生成翻译失败，请重试。" });
            console.error(err);
        }
    } finally {
        AppState.regenerateAllAbortController = null;
        setState({ isRegeneratingAll: false });
    }
}

// ============= 重新生成单条翻译 =============
async function handleRegenerateTranslation(index) {
    const pair = AppState.translationPairs[index];
    if (!pair) return;

    // 如果正在重新生成，则取消
    if (pair.isRegenerating) {
        const controller = AppState.regenerateAbortControllers?.get(index);
        if (controller) {
            controller.abort();
            AppState.regenerateAbortControllers.delete(index);
            updateTranslationPair(index, { isRegenerating: false });
        }
        return;
    }

    // 初始化 AbortController Map (如果不存在)
    if (!AppState.regenerateAbortControllers) {
        AppState.regenerateAbortControllers = new Map();
    }

    const controller = new AbortController();
    AppState.regenerateAbortControllers.set(index, controller);

    // 标记正在重新生成
    updateTranslationPair(index, { isRegenerating: true });

    try {
        const config = getApiConfig();
        const srcText = pair.src;
        const oldTgt = pair.tgt;

        // 使用当前语言设置重新翻译
        const result = await translateBulk(srcText, AppState.sourceLang, AppState.targetLang, config, controller.signal);

        if (result?.translations && result.translations.length > 0) {
            const newTgt = result.translations[0].tgt;

            // 只有当新翻译与旧翻译不同时，才添加到历史记录
            if (newTgt !== oldTgt) {
                addHistory(index, srcText, newTgt);

                // 如果当前正在编辑这一行，同时更新 editValues
                if (AppState.activeIndex === index) {
                    AppState.editValues.tgt = newTgt;
                }
            }
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            setState({ error: err.message || "重新生成翻译失败，请重试。" });
            console.error(err);
        }
    } finally {
        AppState.regenerateAbortControllers?.delete(index);
        updateTranslationPair(index, { isRegenerating: false });
    }
}


// ==================== UI.JS ====================
// ========================================
// ui.js - UI渲染和事件处理
// ========================================

// ============= SVG图标 (使用Lucide图标的SVG) =============
const Icons = {
    Languages: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>`,
    ArrowRightLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>`,
    Copy: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
    Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
    Loader2: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
    Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
    X: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
    Lightbulb: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
    Cpu: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></svg>`,
    Zap: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>`,
    ZapFilled: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>`,
    ZapBig: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>`,
    PenLine: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg>`,
    PenLineSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg>`,
    Eye: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
    RefreshCw: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>`,
    CheckCheck: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></svg>`,
    Feather: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.67 19a2 2 0 0 0 1.416-.588l6.154-6.172a6 6 0 0 0-8.49-8.49L5.586 9.914A2 2 0 0 0 5 11.328V18a1 1 0 0 0 1 1z"/><path d="M16 8 2 22"/><path d="M17.5 15H9"/></svg>`,
    MessageSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    Wand2: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>`,
    Undo2: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
    Redo2: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5A5.5 5.5 0 0 0 9.5 20H13"/></svg>`,
    ChevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
    ChevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
    ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
    Rocket: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`,
    History: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
    Clock: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
    Save: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>`,
    StopCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></svg>`,
    Octagon: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/></svg>`,
    Timer: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>`,
    Settings2: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>`,
    SettingsGear: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
    MoreVertical: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>`,
    Server: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></svg>`,
    Globe: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>`,
    AlertCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`,
    Plug: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>`,
    SparklesSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
    XSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
    ArrowRightLeftSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>`,
    LoaderSmall: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
    LoaderLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
    LoaderMedium: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
};

// ============= 辅助函数 =============
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
}

// 按钮反馈动画：短暂显示成功状态（用于复制按钮等小图标按钮）
function showButtonFeedback(buttonElement, duration = 1500) {
    if (!buttonElement) return;

    // 保存原始内容和样式
    const originalHTML = buttonElement.innerHTML;
    const originalClasses = buttonElement.className;

    // 设置成功状态 - 勾选图标
    const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
    buttonElement.innerHTML = checkIcon;
    buttonElement.classList.remove('text-slate-400', 'hover:text-indigo-600');
    buttonElement.classList.add('text-emerald-500');
    buttonElement.style.transform = 'scale(1.15)';
    buttonElement.style.transition = 'all 0.2s ease';

    // 恢复原始状态
    setTimeout(() => {
        buttonElement.innerHTML = originalHTML;
        buttonElement.className = originalClasses;
        buttonElement.style.transform = '';
        buttonElement.style.transition = '';
    }, duration);
}

// 保存按钮反馈动画（用于 Save API Key 等按钮）
function showSaveButtonFeedback(buttonElement, duration = 1500) {
    if (!buttonElement) return;

    // 保存原始内容和背景色类
    const originalHTML = buttonElement.innerHTML;
    const originalBgClass = [...buttonElement.classList].find(c => c.startsWith('bg-') && !c.includes('opacity'));

    // 设置成功状态 - 绿色背景 + 勾选图标
    const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
    buttonElement.innerHTML = `${checkIcon} <span class="ml-1">Saved!</span>`;

    // 移除原始背景色，添加绿色背景
    if (originalBgClass) {
        buttonElement.classList.remove(originalBgClass);
    }
    buttonElement.classList.add('bg-emerald-500');

    // 恢复原始状态
    setTimeout(() => {
        buttonElement.innerHTML = originalHTML;
        buttonElement.classList.remove('bg-emerald-500');
        if (originalBgClass) {
            buttonElement.classList.add(originalBgClass);
        }
    }, duration);
}

// 连接按钮反馈动画
function showConnectButtonFeedback(buttonElement, modelCount, duration = 2000) {
    if (!buttonElement) return;

    // 保存原始内容
    const originalHTML = buttonElement.innerHTML;
    const originalBgClass = [...buttonElement.classList].find(c => c.startsWith('bg-') && !c.includes('opacity'));

    // 设置成功状态
    const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
    buttonElement.innerHTML = `${checkIcon} <span class="ml-1">Connected! (${modelCount} models)</span>`;

    if (originalBgClass) {
        buttonElement.classList.remove(originalBgClass);
    }
    buttonElement.classList.add('bg-emerald-500');

    // 恢复原始状态
    setTimeout(() => {
        buttonElement.innerHTML = originalHTML;
        buttonElement.classList.remove('bg-emerald-500');
        if (originalBgClass) {
            buttonElement.classList.add(originalBgClass);
        }
    }, duration);
}

// 弹窗位置自动调整函数
function adjustPopupPosition(popupId, padding = 10) {
    requestAnimationFrame(() => {
        const popup = document.getElementById(popupId);
        if (!popup) return;

        const rect = popup.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        // 检查右边是否超出
        if (rect.right > viewportWidth - padding) {
            const overflow = rect.right - viewportWidth + padding;
            popup.style.transform = `translateX(-${overflow}px)`;
        }

        // 检查左边是否超出
        if (rect.left < padding) {
            popup.style.left = `${padding}px`;
            popup.style.right = 'auto';
        }

        // 检查底部是否超出
        if (rect.bottom > viewportHeight - padding) {
            // 如果底部超出，尝试显示在上方
            popup.style.top = 'auto';
            popup.style.bottom = '100%';
            popup.style.marginTop = '0';
            popup.style.marginBottom = '8px';
        }
    });
}

// 渲染后调整所有弹窗位置
function adjustAllPopups() {
    ['modelMenuPopup', 'historyMenuPopup', 'saveMenuPopup', 'synonymPopup'].forEach(id => {
        adjustPopupPosition(id);
    });
}

// ============= 主渲染函数 =============
function renderApp(preserveScroll = true) {
    // 保存滚动位置
    let savedSourceScroll = 0, savedTargetScroll = 0;
    if (preserveScroll) {
        const sourceContainer = document.querySelector('section:first-of-type .overflow-y-auto');
        const targetContainer = document.querySelector('section:last-of-type .overflow-y-auto');
        savedSourceScroll = sourceContainer ? sourceContainer.scrollTop : 0;
        savedTargetScroll = targetContainer ? targetContainer.scrollTop : 0;
    }

    const root = document.getElementById('root');
    root.innerHTML = `
        <div class="min-h-screen bg-slate-50 flex flex-col p-4 md:p-6 max-w-[1600px] mx-auto w-full">
            ${renderErrorBanner()}
            ${renderSettingsModal()}
            ${renderLocalSettingsModal()}
            ${renderSynonymPopup()}
            ${renderToast()}
            ${renderHeader()}
            ${renderMainWorkspace()}
            ${renderFooter()}
        </div>
    `;
    attachEventListeners();

    // 同义词弹窗独立渲染到 body（避免被 root 内容替换影响）
    renderSynonymPopupOnly();

    // 同步恢复滚动位置（不使用 requestAnimationFrame，避免多次渲染时的竞态条件）
    if (preserveScroll) {
        const newSourceContainer = document.querySelector('section:first-of-type .overflow-y-auto');
        const newTargetContainer = document.querySelector('section:last-of-type .overflow-y-auto');
        if (newSourceContainer) newSourceContainer.scrollTop = savedSourceScroll;
        if (newTargetContainer) newTargetContainer.scrollTop = savedTargetScroll;
    }

    // 渲染后调整弹窗位置
    adjustAllPopups();
}

// ============= 错误横幅 =============
function renderErrorBanner() {
    if (!AppState.error) return '';
    return `
        <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-top-4 max-w-lg">
            ${Icons.AlertCircle}
            <span class="text-xs font-medium">${escapeHtml(AppState.error)}</span>
            <button onclick="setState({error:null})" class="ml-2 hover:bg-rose-100 p-1 rounded-full">${Icons.XSmall}</button>
        </div>
    `;
}

// ============= Toast 提示框 =============
function renderToast() {
    if (!AppState.toast) return '';

    const bgColor = {
        'success': 'bg-emerald-50 border-emerald-200 text-emerald-700',
        'warning': 'bg-amber-50 border-amber-200 text-amber-700',
        'info': 'bg-blue-50 border-blue-200 text-blue-700'
    }[AppState.toast.type] || 'bg-slate-50 border-slate-200 text-slate-700';

    return `
        <div class="fixed top-16 left-1/2 -translate-x-1/2 z-[100] ${bgColor} border px-5 py-3 rounded-xl shadow-xl flex items-center gap-3 backdrop-blur-sm bg-opacity-95 transition-all duration-300" onclick="setState({toast:null})">
            <span class="text-sm font-medium">${escapeHtml(AppState.toast.message)}</span>
        </div>
    `;
}

// ============= 设置模态框 =============
function renderSettingsModal() {
    if (!AppState.showSettings) return '';

    const onlineModels = [
        { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', provider: 'gemini', iconClass: 'text-emerald-500' },
        { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash', provider: 'gemini', iconClass: 'text-orange-500' },
        { id: 'gemini-3-pro-preview', name: 'Gemini 3 Pro', provider: 'gemini', iconClass: 'text-indigo-600' },
        { id: 'gpt-5-nano', name: 'GPT-5 Nano', provider: 'openai', iconClass: 'text-teal-500' },
        { id: 'gpt-5-mini', name: 'GPT-5 Mini', provider: 'openai', iconClass: 'text-green-500' },
        { id: 'gpt-5.2', name: 'GPT-5.2', provider: 'openai', iconClass: 'text-sky-600' },
        { id: 'claude-haiku-4-5-20251001', name: 'Claude Haiku 4.5', provider: 'claude', iconClass: 'text-amber-500' },
        { id: 'claude-sonnet-4-5-20250929', name: 'Claude Sonnet 4.5', provider: 'claude', iconClass: 'text-orange-600' },
        { id: 'claude-opus-4-5-20251101', name: 'Claude Opus 4.5', provider: 'claude', iconClass: 'text-rose-600' },
        { id: 'deepseek-chat', name: 'DeepSeek V3.2', provider: 'deepseek', iconClass: 'text-blue-500' },
        { id: 'deepseek-reasoner', name: 'DeepSeek V3.2 Reasoner', provider: 'deepseek', iconClass: 'text-purple-500' }
    ];

    return `
        <div class="fixed inset-0 z-[100] bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 w-full max-w-lg overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50 sticky top-0 z-10">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        ${Icons.SettingsGear} Settings
                    </h3>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600">${Icons.X}</button>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Translation Settings Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-6 h-6 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center text-white">
                                ${Icons.Settings2}
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Translation Settings</span>
                        </div>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 cursor-pointer transition-all ${AppState.isAutoSegment ? 'bg-cyan-50' : 'bg-slate-50'}">
                                <div class="flex-1">
                                    <div class="text-xs font-bold text-slate-700">Auto Segmentation</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">${AppState.isAutoSegment ? 'Split into sentences for side-by-side comparison' : 'Translate as a whole, preserving original layout'}</div>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" ${AppState.isAutoSegment ? 'checked' : ''} onchange="toggleAutoSegment()" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Online Model Visibility Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-6 h-6 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center text-white">
                                ${Icons.Globe}
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Online Models Visibility</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mb-3">Select which online models to show in the model selector.</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${onlineModels.map(m => `
                                <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 cursor-pointer transition-all ${AppState.modelVisibility[m.id] !== false ? 'bg-indigo-50' : ''}">
                                    <input type="checkbox" ${AppState.modelVisibility[m.id] !== false ? 'checked' : ''} onchange="toggleModelVisibility('${m.id}')" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-xs font-medium ${m.iconClass}">${m.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Local Model Visibility Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center text-white">
                                ${Icons.Server}
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Local Models Visibility</span>
                        </div>
                        ${AppState.localModels.length > 0 ? `
                            <p class="text-[10px] text-slate-400 mb-3">Select which local models to show in the model selector.</p>
                            <div class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                ${AppState.localModels.map(lm => `
                                    <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 cursor-pointer transition-all ${AppState.modelVisibility[lm.id] !== false ? 'bg-purple-50' : ''}">
                                        <input type="checkbox" ${AppState.modelVisibility[lm.id] !== false ? 'checked' : ''} onchange="toggleModelVisibility('${escapeHtml(lm.id)}')" class="w-4 h-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500">
                                        <span class="text-xs font-medium text-purple-600 truncate">${escapeHtml(lm.id)}</span>
                                    </label>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-[10px] text-slate-400 italic">No local models available. Connect to LM Studio first.</p>
                        `}
                    </div>

                    <!-- Gemini API Key Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Google Gemini API</span>
                        </div>
                        <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                            <input type="password" id="geminiApiKeyInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none font-mono" value="${escapeHtml(AppState.geminiApiKey)}" placeholder="AIzaSy...">
                            <button onclick="toggleApiKeyVisibility('geminiApiKeyInput')" class="text-slate-400 hover:text-slate-600 ml-2" title="Toggle visibility">
                                ${Icons.Eye}
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">
                            Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank" class="text-indigo-500 hover:underline">Google AI Studio</a>
                        </p>
                        <button id="saveGeminiBtn" onclick="saveGeminiApiKey(this)" class="w-full mt-3 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                            ${Icons.Save} Save API Key
                        </button>
                    </div>

                    <!-- OpenAI API Key Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-br from-teal-500 to-green-600 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">OpenAI API</span>
                        </div>
                        <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-teal-100 transition-all">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                            <input type="password" id="openaiApiKeyInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none font-mono" value="${escapeHtml(AppState.openaiApiKey)}" placeholder="sk-...">
                            <button onclick="toggleApiKeyVisibility('openaiApiKeyInput')" class="text-slate-400 hover:text-slate-600 ml-2" title="Toggle visibility">
                                ${Icons.Eye}
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">
                            Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-teal-500 hover:underline">OpenAI Platform</a>
                        </p>
                        <button id="saveOpenaiBtn" onclick="saveOpenaiApiKey(this)" class="w-full mt-3 py-2.5 bg-teal-600 hover:bg-teal-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-teal-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                            ${Icons.Save} Save API Key
                        </button>
                    </div>

                    <!-- Claude API Key Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-br from-orange-500 to-rose-600 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Anthropic Claude API</span>
                        </div>
                        <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-orange-100 transition-all">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                            <input type="password" id="claudeApiKeyInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none font-mono" value="${escapeHtml(AppState.claudeApiKey)}" placeholder="sk-ant-...">
                            <button onclick="toggleApiKeyVisibility('claudeApiKeyInput')" class="text-slate-400 hover:text-slate-600 ml-2" title="Toggle visibility">
                                ${Icons.Eye}
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">
                            Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank" class="text-orange-500 hover:underline">Anthropic Console</a>
                        </p>

                        <!-- Claude Proxy URL -->
                        <div class="mt-4 mb-3">
                            <label class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide mb-2 block">Proxy URL (Required for CORS)</label>
                            <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-orange-100 transition-all">
                                ${Icons.Globe}
                                <input type="text" id="claudeProxyUrlInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none font-mono" value="${escapeHtml(AppState.claudeProxyUrl)}" placeholder="https://your-worker.workers.dev">
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1 px-1">
                                Claude API requires a CORS proxy. Use <a href="https://developers.cloudflare.com/workers/" target="_blank" class="text-orange-500 hover:underline">Cloudflare Workers</a> to create one.
                            </p>
                        </div>

                        <button id="saveClaudeBtn" onclick="saveClaudeSettings(this)" class="w-full mt-3 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-orange-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                            ${Icons.Save} Save Claude Settings
                        </button>
                    </div>

                    <!-- DeepSeek API Key Section -->
                    <div class="pb-5 border-b border-slate-100">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">DeepSeek API</span>
                        </div>
                        <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                            <input type="password" id="deepseekApiKeyInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none font-mono" value="${escapeHtml(AppState.deepseekApiKey)}" placeholder="sk-...">
                            <button onclick="toggleApiKeyVisibility('deepseekApiKeyInput')" class="text-slate-400 hover:text-slate-600 ml-2" title="Toggle visibility">
                                ${Icons.Eye}
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">
                            Get your API key from <a href="https://platform.deepseek.com/api_keys" target="_blank" class="text-blue-500 hover:underline">DeepSeek Platform</a>
                        </p>
                        <button id="saveDeepseekBtn" onclick="saveDeepseekApiKey(this)" class="w-full mt-3 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                            ${Icons.Save} Save API Key
                        </button>
                    </div>

                    <!-- Local Server Section -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center">
                                ${Icons.Server}
                            </div>
                            <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Local LM Studio</span>
                        </div>
                        <div class="flex items-center bg-slate-50 border border-slate-200 rounded-xl px-3 py-2.5 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                            ${Icons.Globe}
                            <input type="text" id="localUrlInput" class="flex-grow bg-transparent border-none text-xs focus:ring-0 p-0 ml-2 text-slate-700 outline-none" value="${escapeHtml(AppState.localBaseUrl)}" placeholder="http://localhost:1234">
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 px-1">Ensure your local server (e.g., LM Studio) is running and CORS is enabled.</p>
                        <button id="connectLocalBtn" onclick="handleConnectLocalClick(this)" ${AppState.isConnectingLocal ? 'disabled' : ''} class="w-full mt-3 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold text-xs shadow-lg shadow-purple-200 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            ${AppState.isConnectingLocal ? Icons.Loader2 : Icons.Plug}
                            ${AppState.isConnectingLocal ? 'Connecting...' : 'Connect & Fetch Models'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============= 本地设置模态框（保留旧接口兼容性）=============
function renderLocalSettingsModal() {
    if (!AppState.showLocalSettings) return '';
    // 重定向到新的设置模态框
    AppState.showSettings = true;
    AppState.showLocalSettings = false;
    return '';
}

// ============= 同义词弹窗（现在由 renderSynonymPopupOnly 独立管理）=============
function renderSynonymPopup() {
    // 弹窗现在直接插入到 body，不在 root 内渲染
    return '';
}

// ============= 头部 =============
function renderHeader() {
    return `
        <header class="bg-white rounded-3xl shadow-sm border border-slate-200 mb-4 px-8 py-5 flex flex-wrap items-center justify-between gap-6 relative z-50">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 p-3 rounded-2xl text-white shadow-xl shadow-indigo-100">
                    ${Icons.Languages}
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight leading-none">Academic AI</h1>
                    <p class="text-[11px] text-indigo-500 font-bold tracking-widest uppercase mt-1">LaTeX & Terminology Optimized</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                ${renderSettingsButton()}
                ${renderSaveButtonGroup()}
                ${renderHistoryMenu()}
                <div class="h-6 w-px bg-slate-200 mx-2"></div>
                ${renderModelSelector()}
                ${renderControlButtons()}
            </div>

            <div class="flex items-center gap-3">
                <button onclick="handleSummary()" ${AppState.translationPairs.length === 0 ? 'disabled' : ''} class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-2xl hover:bg-slate-50 hover:border-indigo-200 transition-all font-semibold flex items-center gap-2 group disabled:opacity-50">
                    <span class="text-indigo-500 group-hover:animate-pulse">${Icons.Sparkles}</span> Insight
                </button>
                <button onclick="handleTranslate()" ${!AppState.inputText && !AppState.isLoading ? 'disabled' : ''} class="px-10 py-2.5 rounded-2xl font-black text-sm tracking-wider transition-all shadow-xl active:scale-95 flex items-center gap-2 ${!AppState.inputText && !AppState.isLoading ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : AppState.isLoading ? 'bg-rose-500 text-white hover:bg-rose-600 shadow-rose-200' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200'}">
                    ${AppState.isLoading ? `<span class="animate-pulse">${Icons.StopCircle}</span> STOP` : 'TRANSLATE'}
                </button>
                <button onclick="handleRegenerateAll()" ${AppState.translationPairs.length === 0 ? 'disabled' : ''} class="p-2.5 rounded-2xl transition-all shadow-xl active:scale-95 flex items-center justify-center ${AppState.translationPairs.length === 0 ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : AppState.isRegeneratingAll ? 'bg-rose-500 text-white hover:bg-rose-600 shadow-rose-200' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200'}" title="重新生成所有翻译">
                    ${AppState.isRegeneratingAll ? `<span class="animate-pulse">${Icons.StopCircle}</span>` : Icons.RefreshCw}
                </button>
            </div>
        </header>
    `;
}

// ============= 设置按钮 =============
function renderSettingsButton() {
    return `
        <div class="relative">
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all" title="Settings">
                ${Icons.SettingsGear}
            </button>
        </div>
    `;
}

// ============= 保存按钮组 =============
function renderSaveButtonGroup() {
    return `
        <div class="relative flex items-center bg-slate-100 rounded-full border border-slate-200">
            <button onclick="handleManualSave()" ${AppState.translationPairs.length === 0 ? 'disabled' : ''} class="pl-3 pr-2 py-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-l-full transition-all disabled:opacity-30 flex items-center gap-1 border-r border-slate-200" title="Manual Save Session">
                ${Icons.Save}
            </button>
            <button onclick="toggleSaveMenu()" class="pl-1 pr-2 py-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-r-full transition-all" title="Auto-Save Settings">
                ${Icons.MoreVertical}
            </button>
            ${AppState.showSaveMenu ? `
                <div id="saveMenuPopup" class="absolute top-full right-0 mt-2 w-64 bg-white border border-slate-200 shadow-xl rounded-2xl p-3 z-[60]">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">Auto-Save Interval</div>
                    <div class="space-y-1">
                        ${[1, 3, 5, 10].map(min => `
                            <button onclick="setAutoSaveInterval(${min * 60 * 1000})" class="w-full text-left px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${AppState.autoSaveInterval === min * 60 * 1000 ? 'bg-emerald-50 text-emerald-600' : 'hover:bg-slate-50 text-slate-600'}">
                                ${min} Minutes
                            </button>
                        `).join('')}
                    </div>
                    <div class="border-t border-slate-100 mt-2 pt-2 px-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500">Custom (min):</span>
                            <input type="number" id="customAutoSaveInput" min="1" class="w-12 text-xs p-1 border border-slate-200 rounded text-center bg-slate-50" placeholder="${Math.floor(AppState.autoSaveInterval / 60000)}">
                            <button onclick="applyCustomAutoSave()" class="px-2 py-1 bg-emerald-500 hover:bg-emerald-600 text-white text-[10px] font-bold rounded transition-colors">OK</button>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// ============= 历史菜单 =============
function renderHistoryMenu() {
    return `
        <div class="relative">
            <button onclick="toggleHistoryMenu()" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all" title="Global Session History">
                ${Icons.History}
            </button>
            ${AppState.showHistoryMenu ? `
                <div id="historyMenuPopup" class="absolute top-full right-0 mt-2 w-80 bg-white border border-slate-200 shadow-2xl rounded-2xl p-4 z-[70]">
                    <!-- History Settings Header -->
                    <div class="mb-4 pb-3 border-b border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            ${Icons.Settings2} History Settings
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <span class="text-xs text-slate-600 font-medium">Keep Last:</span>
                            <div class="flex items-center bg-slate-100 rounded-lg p-0.5">
                                ${[5, 10, 20].map(limit => `
                                    <button onclick="setHistoryLimit(${limit})" class="px-2 py-0.5 rounded-md text-[10px] font-bold transition-all ${AppState.historyLimit === limit ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}">
                                        ${limit}
                                    </button>
                                `).join('')}
                                <div class="w-px h-3 bg-slate-200 mx-1"></div>
                                <input type="number" id="customHistoryLimitInput" min="1" value="${AppState.historyLimit}" class="w-8 bg-transparent text-[10px] font-bold text-center outline-none text-slate-600 border-none" onchange="setHistoryLimitCustom(this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        ${Icons.Clock} Recent Sessions
                    </h4>
                    ${AppState.globalHistory.length === 0 ? `
                        <div class="text-center py-4 text-slate-300 text-xs italic">No history available yet.</div>
                    ` : `
                        <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                            ${AppState.globalHistory.map((item, idx) => `
                                <button onclick="restoreHistoryItem(${idx})" class="w-full text-left p-3 rounded-xl border transition-all group ${item.id === AppState.sessionId ? 'bg-indigo-50 border-indigo-200' : 'bg-slate-50 border-slate-100 hover:bg-white hover:border-indigo-100'}">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] font-bold ${item.id === AppState.sessionId ? 'text-indigo-600' : 'text-slate-400 group-hover:text-indigo-400'}">
                                            ${new Date(item.timestamp).toLocaleTimeString()}${item.id === AppState.sessionId ? ' (Current)' : ''}
                                        </span>
                                        <span class="text-[9px] bg-slate-200 text-slate-500 px-1.5 rounded group-hover:bg-indigo-200 group-hover:text-indigo-700">
                                            ${item.pairs.length} segs
                                        </span>
                                    </div>
                                    <p class="text-xs text-slate-600 line-clamp-2 leading-relaxed">
                                        ${escapeHtml(item.pairs[0]?.src || 'Empty content')}
                                    </p>
                                </button>
                            `).join('')}
                        </div>
                    `}
                </div>
            ` : ''}
        </div>
    `;
}

// ============= 模型选择器 =============
function renderModelSelector() {
    const allGeminiModels = [
        { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', sub: 'Fast & Cheap', iconClass: 'text-emerald-500', icon: Icons.Rocket },
        { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash', sub: 'Speed + Intelligence', iconClass: 'text-orange-500', icon: Icons.Zap },
        { id: 'gemini-3-pro-preview', name: 'Gemini 3 Pro', sub: 'Best Quality', iconClass: 'text-indigo-600', icon: Icons.Cpu }
    ];

    const allOpenaiModels = [
        { id: 'gpt-5-nano', name: 'GPT-5 Nano', sub: 'Ultra Fast & Light', iconClass: 'text-teal-500', icon: Icons.Rocket },
        { id: 'gpt-5-mini', name: 'GPT-5 Mini', sub: 'Fast & Balanced', iconClass: 'text-green-500', icon: Icons.Zap },
        { id: 'gpt-5.2', name: 'GPT-5.2', sub: 'Best Quality', iconClass: 'text-sky-600', icon: Icons.Cpu }
    ];

    const allClaudeModels = [
        { id: 'claude-haiku-4-5-20251001', name: 'Claude Haiku 4.5', sub: 'Fast & Efficient', iconClass: 'text-amber-500', icon: Icons.Rocket },
        { id: 'claude-sonnet-4-5-20250929', name: 'Claude Sonnet 4.5', sub: 'Balanced Performance', iconClass: 'text-orange-600', icon: Icons.Zap },
        { id: 'claude-opus-4-5-20251101', name: 'Claude Opus 4.5', sub: 'Best Quality', iconClass: 'text-rose-600', icon: Icons.Cpu }
    ];

    const allDeepseekModels = [
        { id: 'deepseek-chat', name: 'DeepSeek V3.2', sub: 'Non-thinking Mode', iconClass: 'text-blue-500', icon: Icons.Zap },
        { id: 'deepseek-reasoner', name: 'DeepSeek V3.2 Reasoner', sub: 'Thinking Mode', iconClass: 'text-purple-500', icon: Icons.Lightbulb }
    ];

    // 根据可见性设置筛选模型
    const geminiModels = allGeminiModels.filter(m => AppState.modelVisibility[m.id] !== false);
    const openaiModels = allOpenaiModels.filter(m => AppState.modelVisibility[m.id] !== false);
    const claudeModels = allClaudeModels.filter(m => AppState.modelVisibility[m.id] !== false);
    const deepseekModels = allDeepseekModels.filter(m => AppState.modelVisibility[m.id] !== false);

    let currentIcon, currentIconClass, currentLabel;
    if (AppState.apiProvider === 'local') {
        currentIcon = Icons.Server;
        currentIconClass = 'text-indigo-600';
        currentLabel = AppState.selectedModel === 'local-model' ? 'Local LLM' : (AppState.selectedModel.length > 15 ? AppState.selectedModel.slice(0, 15) + '...' : AppState.selectedModel);
    } else if (AppState.apiProvider === 'openai') {
        const openaiModel = allOpenaiModels.find(m => m.id === AppState.selectedModel);
        currentIcon = openaiModel?.icon || Icons.Cpu;
        currentIconClass = openaiModel?.iconClass || 'text-sky-600';
        currentLabel = AppState.selectedModel === 'gpt-5-nano' ? 'GPT-5 Nano' :
                       AppState.selectedModel === 'gpt-5-mini' ? 'GPT-5 Mini' : 'GPT-5.2';
    } else if (AppState.apiProvider === 'claude') {
        const claudeModel = allClaudeModels.find(m => m.id === AppState.selectedModel);
        currentIcon = claudeModel?.icon || Icons.Cpu;
        currentIconClass = claudeModel?.iconClass || 'text-orange-600';
        currentLabel = AppState.selectedModel.includes('haiku') ? 'Haiku' :
                       AppState.selectedModel.includes('sonnet') ? 'Sonnet 4.5' : 'Opus 4.5';
    } else if (AppState.apiProvider === 'deepseek') {
        const deepseekModel = allDeepseekModels.find(m => m.id === AppState.selectedModel);
        currentIcon = deepseekModel?.icon || Icons.Zap;
        currentIconClass = deepseekModel?.iconClass || 'text-blue-500';
        currentLabel = AppState.selectedModel === 'deepseek-reasoner' ? 'V3.2 Reasoner' : 'DeepSeek V3.2';
    } else if (AppState.selectedModel === 'gemini-2.5-flash-lite') {
        currentIcon = Icons.Rocket;
        currentIconClass = 'text-emerald-500';
        currentLabel = '2.5 Lite';
    } else if (AppState.selectedModel === 'gemini-3-flash-preview') {
        currentIcon = Icons.Zap;
        currentIconClass = 'text-orange-500';
        currentLabel = '3 Flash';
    } else {
        currentIcon = Icons.Cpu;
        currentIconClass = 'text-indigo-600';
        currentLabel = '3 Pro';
    }

    return `
        <div class="relative">
            <button onclick="toggleModelMenu()" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-2xl border border-slate-200 transition-all text-xs font-bold text-slate-700 active:scale-95">
                <span class="${currentIconClass}">${currentIcon}</span>
                <span class="uppercase tracking-wider">${currentLabel}</span>
                <span class="transition-transform duration-200 ${AppState.showModelMenu ? 'rotate-180' : ''}">${Icons.ChevronDown}</span>
            </button>
            ${AppState.showModelMenu ? `
                <div id="modelMenuPopup" class="absolute top-full mt-2 left-0 w-72 bg-white border border-slate-200 shadow-2xl rounded-2xl overflow-hidden z-[60]">
                    <div class="p-2 space-y-1 bg-slate-50/50 border-b border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 px-2 py-1 uppercase">Google Cloud (Gemini)</div>
                        ${geminiModels.map(m => `
                            <button onclick="selectModel('gemini','${m.id}')" class="w-full flex items-center justify-between p-2.5 rounded-xl transition-all ${AppState.apiProvider === 'gemini' && AppState.selectedModel === m.id ? 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200' : 'hover:bg-white hover:shadow-sm text-slate-600'}">
                                <div class="flex flex-col items-start">
                                    <span class="text-xs font-bold uppercase tracking-wide">${m.name}</span>
                                    <span class="text-[9px] opacity-70">${m.sub}</span>
                                </div>
                                <span class="${m.iconClass}">${m.icon}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-2 space-y-1 bg-sky-50/50 border-b border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 px-2 py-1 uppercase flex items-center gap-2">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/></svg>
                            OpenAI
                        </div>
                        ${openaiModels.map(m => `
                            <button onclick="selectModel('openai','${m.id}')" class="w-full flex items-center justify-between p-2.5 rounded-xl transition-all ${AppState.apiProvider === 'openai' && AppState.selectedModel === m.id ? 'bg-sky-50 text-sky-700 ring-1 ring-sky-200' : 'hover:bg-white hover:shadow-sm text-slate-600'}">
                                <div class="flex flex-col items-start">
                                    <span class="text-xs font-bold uppercase tracking-wide">${m.name}</span>
                                    <span class="text-[9px] opacity-70">${m.sub}</span>
                                </div>
                                <span class="${m.iconClass}">${m.icon}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-2 space-y-1 bg-orange-50/50 border-b border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 px-2 py-1 uppercase flex items-center gap-2">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            Anthropic Claude
                        </div>
                        ${claudeModels.map(m => `
                            <button onclick="selectModel('claude','${m.id}')" class="w-full flex items-center justify-between p-2.5 rounded-xl transition-all ${AppState.apiProvider === 'claude' && AppState.selectedModel === m.id ? 'bg-orange-50 text-orange-700 ring-1 ring-orange-200' : 'hover:bg-white hover:shadow-sm text-slate-600'}">
                                <div class="flex flex-col items-start">
                                    <span class="text-xs font-bold uppercase tracking-wide">${m.name}</span>
                                    <span class="text-[9px] opacity-70">${m.sub}</span>
                                </div>
                                <span class="${m.iconClass}">${m.icon}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-2 space-y-1 bg-blue-50/50 border-b border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 px-2 py-1 uppercase flex items-center gap-2">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            DeepSeek
                        </div>
                        ${deepseekModels.map(m => `
                            <button onclick="selectModel('deepseek','${m.id}')" class="w-full flex items-center justify-between p-2.5 rounded-xl transition-all ${AppState.apiProvider === 'deepseek' && AppState.selectedModel === m.id ? 'bg-blue-50 text-blue-700 ring-1 ring-blue-200' : 'hover:bg-white hover:shadow-sm text-slate-600'}">
                                <div class="flex flex-col items-start">
                                    <span class="text-xs font-bold uppercase tracking-wide">${m.name}</span>
                                    <span class="text-[9px] opacity-70">${m.sub}</span>
                                </div>
                                <span class="${m.iconClass}">${m.icon}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="p-2 bg-white">
                        <div class="text-[10px] font-bold text-slate-400 px-2 py-1 uppercase flex items-center justify-between">
                            <span>Local LM Studio</span>
                            ${Icons.Server}
                        </div>
                        ${(() => {
                            const visibleLocalModels = AppState.localModels.filter(lm => AppState.modelVisibility[lm.id] !== false);
                            return visibleLocalModels.length > 0 ? `
                                <div class="max-h-40 overflow-y-auto custom-scrollbar my-1">
                                    ${visibleLocalModels.map(lm => `
                                        <button onclick="selectModel('local','${escapeHtml(lm.id)}')" class="w-full flex items-center justify-between p-2 rounded-xl transition-all mb-1 ${AppState.apiProvider === 'local' && AppState.selectedModel === lm.id ? 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200' : 'hover:bg-slate-50 text-slate-600'}">
                                            <div class="flex flex-col items-start w-full overflow-hidden">
                                                <span class="text-xs font-bold truncate w-full text-left">${escapeHtml(lm.id)}</span>
                                            </div>
                                            ${AppState.apiProvider === 'local' && AppState.selectedModel === lm.id ? '<div class="w-1.5 h-1.5 rounded-full bg-indigo-600 ml-2 shrink-0"></div>' : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : AppState.localModels.length > 0 ? `
                                <div class="text-[10px] text-slate-400 italic text-center py-2 bg-slate-50 rounded-lg mb-2">All local models hidden. Check Settings.</div>
                            ` : `
                                <div class="text-[10px] text-slate-400 italic text-center py-2 bg-slate-50 rounded-lg mb-2">No models fetched yet.</div>
                            `;
                        })()}
                        <button onclick="openSettings()" class="w-full flex items-center justify-center gap-2 p-2 mt-1 rounded-xl bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 text-xs font-bold transition-all border border-transparent hover:border-indigo-100">
                            ${Icons.SettingsGear} Settings
                        </button>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// ============= 控制按钮 =============
function renderControlButtons() {
    return `
        <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-full border border-slate-200 shadow-inner">
            <button onclick="toggleAutoTranslate()" class="px-4 py-1.5 rounded-full text-[10px] font-bold flex items-center gap-2 transition-all ${AppState.isAutoTranslate ? 'bg-orange-500 text-white shadow-md' : 'text-slate-500'}">
                ${AppState.isAutoTranslate ? Icons.ZapFilled : Icons.Zap} AUTO SYNC
            </button>
            <button onclick="toggleAutoDetect()" class="px-4 py-1.5 rounded-full text-[10px] font-bold transition-all ${AppState.isAutoDetect ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500'}">DETECT</button>
            <div class="h-4 w-px bg-slate-300 mx-1"></div>
            <button onclick="setLanguage('zh','en')" class="px-5 py-2 rounded-full text-xs font-bold transition-all ${AppState.sourceLang === 'zh' ? 'bg-white shadow-sm text-indigo-700' : 'text-slate-500 hover:text-indigo-600'}">ZH</button>
            <button onclick="swapLanguages()" class="p-2 text-slate-400 hover:bg-white rounded-full transition-colors">${Icons.ArrowRightLeft}</button>
            <button onclick="setLanguage('en','zh')" class="px-5 py-2 rounded-full text-xs font-bold transition-all ${AppState.sourceLang === 'en' ? 'bg-white shadow-sm text-indigo-700' : 'text-slate-500 hover:text-indigo-600'}">EN</button>
        </div>
    `;
}

// ============= 主工作区 =============
function renderMainWorkspace() {
    return `
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-grow relative overflow-hidden" style="height: calc(100vh - 220px);">
            ${renderSourcePanel()}
            ${renderTargetPanel()}
        </main>
    `;
}

// ============= 源面板 =============
function renderSourcePanel() {
    return `
        <section class="bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden relative group">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                    Source Panel
                    ${AppState.activeIndex !== null ? `<span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full text-[9px] flex items-center gap-1.5 animate-pulse">${Icons.PenLineSmall} Editing</span>` : ''}
                </h3>
                <div class="flex items-center gap-3">
                    ${AppState.translationPairs.length > 0 ? `
                        <button id="copySourceBtn" onclick="copySourceText(this)" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" title="Copy Source Text">
                            ${Icons.Copy}
                        </button>
                        <div class="flex items-center bg-slate-100 rounded-xl p-0.5 border border-slate-200">
                            <button onclick="setViewMode('edit')" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 ${AppState.viewMode === 'edit' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                ${Icons.PenLine} Edit
                            </button>
                            <button onclick="setViewMode('preview')" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 ${AppState.viewMode === 'preview' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                ${Icons.Eye} Preview
                            </button>
                            <button onclick="setViewMode('original')" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 ${AppState.viewMode === 'original' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}" title="显示原始输入内容">
                                ${Icons.History} Original
                            </button>
                        </div>
                    ` : ''}
                    <button onclick="handleClear()" class="text-slate-400 hover:text-rose-500 p-2 transition-colors">${Icons.Trash2}</button>
                </div>
            </div>
            <div class="flex-grow flex flex-col overflow-hidden bg-slate-50/20">
                ${AppState.translationPairs.length > 0 && AppState.viewMode === 'preview' ? `
                    <div class="overflow-y-auto h-full custom-scrollbar p-4 space-y-2" onclick="handleBlankAreaClick(event)">
                        ${AppState.translationPairs.map((pair, idx) => renderPairRow('src', pair, idx)).join('')}
                    </div>
                ` : AppState.translationPairs.length > 0 && AppState.viewMode === 'original' ? `
                    <div class="w-full h-full p-10 overflow-y-auto custom-scrollbar">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                            ${Icons.History} 原始输入内容 (用于重新生成翻译)
                        </div>
                        <pre class="text-base text-slate-700 whitespace-pre-wrap font-medium leading-relaxed">${escapeHtml(AppState.originalInputText || AppState.inputText)}</pre>
                    </div>
                ` : `
                    <textarea id="mainInput" class="w-full h-full p-10 text-xl border-none focus:ring-0 placeholder-slate-300 resize-none leading-relaxed custom-scrollbar bg-transparent focus:outline-none font-medium text-slate-700 selection:bg-indigo-100" placeholder="Paste or type academic text here...">${escapeHtml(AppState.inputText)}</textarea>
                `}
            </div>
        </section>
    `;
}

// ============= 目标面板 =============
function renderTargetPanel() {
    return `
        <section class="bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden relative group">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Target Panel</h3>
                <button id="copyTargetBtn" onclick="copyTargetText(this)" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors">${Icons.Copy}</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto custom-scrollbar bg-slate-50/20" onclick="handleBlankAreaClick(event)">
                ${AppState.isLoading && AppState.translationPairs.length === 0 ? `
                    <div class="h-full flex flex-col items-center justify-center text-slate-400 animate-pulse">
                        <span class="text-indigo-300 mb-6">${Icons.LoaderLarge}</span>
                        <p class="font-black text-lg tracking-widest uppercase">Initializing Translation...</p>
                    </div>
                ` : AppState.translationPairs.length === 0 ? `
                    <div class="h-full flex flex-col items-center justify-center text-slate-300/40">
                        <div class="p-8 bg-slate-100 rounded-full mb-6">${Icons.ZapBig}</div>
                        <p class="text-xl font-black uppercase tracking-widest">Awaiting Input</p>
                    </div>
                ` : `
                    <div class="space-y-2 pb-24" onclick="handleBlankAreaClick(event)">
                        ${AppState.translationPairs.map((pair, idx) => renderPairRow('tgt', pair, idx)).join('')}
                    </div>
                `}
            </div>
            ${renderAiInsightDrawer()}
        </section>
    `;
}

// ============= AI Insight抽屉 =============
function renderAiInsightDrawer() {
    if (!AppState.aiInsight) return '';
    return `
        <div class="absolute inset-y-0 right-0 w-full md:w-[450px] bg-white border-l border-slate-200 shadow-2xl z-50 flex flex-col">
            <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-indigo-50/30">
                <div class="flex items-center gap-3 text-indigo-800 font-black text-sm uppercase tracking-widest">
                    <span class="text-amber-500">${Icons.Lightbulb}</span>
                    ${escapeHtml(AppState.aiInsight.title)}
                </div>
                <button onclick="setState({aiInsight:null})" class="p-2 text-slate-400 hover:text-slate-900 transition-colors">${Icons.X}</button>
            </div>
            <div class="flex-grow p-8 overflow-y-auto custom-scrollbar bg-white">
                ${AppState.isInsightLoading ? `
                    <div class="flex flex-col items-center justify-center mt-20 gap-4">
                        <span class="text-indigo-500">${Icons.LoaderMedium}</span>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Analysing semantic structure...</p>
                    </div>
                ` : `
                    <div class="prose prose-indigo prose-sm max-w-none text-slate-600 leading-relaxed">${renderFormattedText(AppState.aiInsight.content)}</div>
                `}
            </div>
        </div>
    `;
}

// ============= 翻译对行渲染 =============
function renderPairRow(side, pair, idx) {
    const isEditing = AppState.activeIndex === idx;
    const textValue = side === 'src' ? pair.src : pair.tgt;
    const editValue = side === 'src' ? AppState.editValues.src : AppState.editValues.tgt;

    if (isEditing) {
        return `
            <div class="group relative p-4 rounded-xl transition-all border cursor-pointer mb-2 bg-white border-indigo-300 shadow-xl ring-4 ring-indigo-50 z-20 scale-[1.01] my-4" data-idx="${idx}" data-side="${side}">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-30">
                    ${renderHistoryControls(pair, idx)}
                </div>
                <div class="relative flex flex-col gap-3">
                    <div class="absolute -top-10 right-0 z-40 flex items-center gap-2">
                        <button onclick="event.stopPropagation();triggerSaveRowUpdate(${idx});" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-white text-xs font-bold shadow-lg transition-all ${pair.isUpdating ? 'bg-rose-500 hover:bg-rose-600' : 'bg-indigo-600 hover:bg-indigo-700'}" title="${pair.isUpdating ? '停止 AI 更新' : '保存并更新'}">
                            ${pair.isUpdating ? `<span class="animate-pulse">${Icons.StopCircle}</span> Stop` : `${Icons.PenLineSmall} Update`}
                        </button>
                        <button onclick="event.stopPropagation();handleRegenerateTranslation(${idx});" class="flex items-center justify-center p-1.5 rounded-lg text-white shadow-lg transition-all ${pair.isRegenerating ? 'bg-rose-500 hover:bg-rose-600' : 'bg-indigo-600 hover:bg-indigo-700'}" title="${pair.isRegenerating ? '停止重新生成' : '重新生成此翻译'}">
                            ${pair.isRegenerating ? `<span class="animate-pulse">${Icons.StopCircle}</span>` : Icons.RefreshCw}
                        </button>
                    </div>
                    <textarea id="editTextarea_${side}_${idx}" class="w-full bg-transparent border-none focus:ring-0 p-0 text-slate-800 leading-relaxed resize-none overflow-hidden min-h-[40px]" placeholder="Edit ${side === 'src' ? 'source' : 'target'}..." onclick="event.stopPropagation();">${escapeHtml(editValue)}</textarea>
                    ${renderAiToolbar(side, idx)}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="group relative p-4 rounded-xl transition-all border cursor-pointer mb-2 border-transparent hover:bg-white/80 hover:shadow-md" onclick="handleRowClick(${idx},'${side}')" data-idx="${idx}" data-side="${side}">
                <div class="prose prose-slate prose-sm max-w-none text-slate-700 leading-relaxed transition-all ${pair.isUpdating ? 'opacity-30 blur-[2px]' : ''}">${renderFormattedText(textValue)}</div>
            </div>
        `;
    }
}

// ============= 历史控制按钮 =============
function renderHistoryControls(pair, idx) {
    return `
        <div class="flex gap-1 bg-white shadow-sm border border-slate-200 rounded-full p-0.5 z-20 transition-all">
            <button onclick="event.stopPropagation();handleHistoryNav(${idx},-1);" ${pair.historyIndex <= 0 ? 'disabled' : ''} class="p-1 hover:bg-slate-100 rounded-full disabled:opacity-30 text-slate-600 transition-colors" title="Undo Change">
                ${Icons.Undo2}
            </button>
            <span class="text-[9px] px-1 text-slate-400 font-mono flex items-center select-none">
                ${pair.historyIndex + 1}/${pair.history.length}
            </span>
            <button onclick="event.stopPropagation();handleHistoryNav(${idx},1);" ${pair.historyIndex >= pair.history.length - 1 ? 'disabled' : ''} class="p-1 hover:bg-slate-100 rounded-full disabled:opacity-30 text-slate-600 transition-colors" title="Redo Change">
                ${Icons.Redo2}
            </button>
        </div>
    `;
}

// ============= AI工具栏 =============
function renderAiToolbar(side, idx) {
    const isGrammarSettingsOpen = AppState.activeSettingsPopup === 'grammar' && AppState.activeSettingsIndex === idx && AppState.activeSettingsSide === side;
    const isSimplifySettingsOpen = AppState.activeSettingsPopup === 'simplify' && AppState.activeSettingsIndex === idx && AppState.activeSettingsSide === side;

    return `
        <div class="mt-2 pt-2 border-t border-indigo-50 flex flex-wrap items-center gap-2 relative" onclick="event.stopPropagation();">
            <div class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mr-1 flex items-center gap-1 select-none">
                ${Icons.SparklesSmall} ${side === 'src' ? 'Source AI' : 'Target AI'}
            </div>

            <!-- Grammar Button Group -->
            <div class="flex items-stretch rounded-lg bg-indigo-50 border border-indigo-100 relative">
                <button onclick="handleAiRefine(${idx},'${side}','grammar')" ${AppState.isRefining ? 'disabled' : ''} class="flex items-center gap-1.5 px-2 py-1 hover:bg-indigo-100 text-indigo-700 rounded-l-lg text-xs transition-colors disabled:opacity-50">
                    ${Icons.CheckCheck} Grammar
                </button>
                <div class="w-px bg-indigo-200 my-1"></div>
                <button onclick="toggleSettingsPopup('grammar',${idx},'${side}')" class="px-1 hover:bg-indigo-200 text-indigo-400 hover:text-indigo-700 rounded-r-lg transition-colors">
                    ${Icons.MoreVertical}
                </button>
                ${isGrammarSettingsOpen ? renderSettingsPopover('grammar') : ''}
            </div>

            <!-- Simplify Button Group -->
            <div class="flex items-stretch rounded-lg bg-emerald-50 border border-emerald-100 relative">
                <button onclick="handleAiRefine(${idx},'${side}','simplify')" ${AppState.isRefining ? 'disabled' : ''} class="flex items-center gap-1.5 px-2 py-1 hover:bg-emerald-100 text-emerald-700 rounded-l-lg text-xs transition-colors disabled:opacity-50">
                    ${Icons.Feather} Simplify
                </button>
                <div class="w-px bg-emerald-200 my-1"></div>
                <button onclick="toggleSettingsPopup('simplify',${idx},'${side}')" class="px-1 hover:bg-emerald-200 text-emerald-400 hover:text-emerald-700 rounded-r-lg transition-colors">
                    ${Icons.MoreVertical}
                </button>
                ${isSimplifySettingsOpen ? renderSettingsPopover('simplify') : ''}
            </div>

            <!-- Custom Rewrite Input -->
            <div class="flex-grow flex items-center gap-2 bg-indigo-50/50 rounded border border-indigo-100 px-2 py-0.5 focus-within:ring-1 focus-within:ring-indigo-200 transition-all">
                <span class="text-indigo-300">${Icons.MessageSquare}</span>
                <input type="text" id="refineInput_${side}_${idx}" class="bg-transparent border-none text-xs w-full focus:ring-0 p-0 text-slate-700 placeholder-indigo-200" placeholder="${side === 'src' ? 'e.g. Make it formal...' : 'e.g. More concise...'}" value="${escapeHtml(AppState.refinePrompt)}">
                <button onclick="triggerCustomRefine(${idx},'${side}')" ${AppState.isRefining || !AppState.refinePrompt.trim() ? 'disabled' : ''} class="text-indigo-600 hover:text-indigo-800 disabled:opacity-30 transition-colors">
                    ${AppState.isRefining ? Icons.LoaderSmall : Icons.Wand2}
                </button>
            </div>
        </div>
    `;
}

// ============= 设置弹窗渲染 =============
function renderSettingsPopover(type) {
    const currentPrompt = AppState.customPrompts[type] || '';
    const defaultPrompt = type === 'grammar' ? DEFAULT_GRAMMAR_PROMPT : DEFAULT_SIMPLIFY_PROMPT;
    const isUsingCustom = currentPrompt.trim().length > 0;
    const colorClass = type === 'grammar' ? 'indigo' : 'emerald';
    
    return `
        <div class="absolute top-full left-0 mt-2 w-72 bg-white border border-slate-200 shadow-xl rounded-xl p-3 z-50" onclick="event.stopPropagation();">
            <div class="flex items-center justify-between gap-2 text-xs font-bold text-slate-700 mb-2 border-b border-slate-100 pb-2">
                <span class="flex items-center gap-2">
                    ${Icons.Settings2} Customize ${type === 'grammar' ? 'Grammar' : 'Simplify'} Prompt
                </span>
                <button onclick="closeSettingsPopup()" class="text-slate-400 hover:text-slate-600">${Icons.XSmall}</button>
            </div>
            <div>
                <textarea 
                    id="customPromptTextarea_${type}"
                    class="w-full text-xs p-2 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-${colorClass}-500 outline-none resize-none"
                    rows="4"
                    placeholder="${escapeHtml(defaultPrompt)}"
                    onclick="event.stopPropagation();"
                >${escapeHtml(currentPrompt)}</textarea>
                <div class="mt-2 flex items-center justify-between">
                    <span class="text-[9px] text-slate-400 italic">
                        ${isUsingCustom ? 'Using custom prompt' : 'Using default prompt'}
                    </span>
                    <div class="flex items-center gap-2">
                        <button onclick="resetPromptToDefault('${type}')" class="px-2 py-1 text-[10px] font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded transition-colors">
                            Reset
                        </button>
                        <button onclick="saveCustomPrompt('${type}')" class="px-2 py-1 text-[10px] font-bold text-white bg-${colorClass}-600 hover:bg-${colorClass}-700 rounded transition-colors">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============= 页脚 =============
function renderFooter() {
    let statusText, statusDotClass;
    if (AppState.apiProvider === 'local') {
        statusText = 'LOCAL SERVER CONNECTED';
        statusDotClass = 'bg-indigo-600 shadow-indigo-200';
    } else if (AppState.selectedModel === 'gemini-flash-lite-latest') {
        statusText = 'ULTRA FAST LITE MODE';
        statusDotClass = 'bg-emerald-500 shadow-emerald-200';
    } else if (AppState.selectedModel === 'gemini-3-flash-preview') {
        statusText = 'FAST MODE ENABLED';
        statusDotClass = 'bg-emerald-500 shadow-emerald-200';
    } else {
        statusText = 'PRO QUALITY ACTIVE';
        statusDotClass = 'bg-emerald-500 shadow-emerald-200';
    }

    return `
        <footer class="mt-4 flex items-center justify-between px-4 text-[10px] text-slate-400 font-mono uppercase tracking-[0.2em] border-t border-slate-200 pt-4">
            <div class="flex gap-6 items-center">
                <span class="flex items-center gap-2 text-indigo-500 font-black">
                    ${AppState.apiProvider === 'local' ? Icons.Server : Icons.Cpu}
                    ENGINE: <span class="text-slate-600 truncate max-w-[150px]">${AppState.apiProvider === 'local' ? escapeHtml(AppState.selectedModel) : AppState.selectedModel.toUpperCase()}</span>
                </span>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full animate-pulse shadow-lg ${statusDotClass}"></span>
                    ${statusText}
                </div>
            </div>
            <div class="hidden sm:block">Select text to find academic synonyms • Incremental AI Refine enabled</div>
        </footer>
    `;
}

// ============= 事件绑定 =============
function attachEventListeners() {
    // 主输入框
    const mainInput = document.getElementById('mainInput');
    if (mainInput) {
        mainInput.addEventListener('input', (e) => handleInputChange(e.target.value));
    }

    // 编辑文本框
    AppState.translationPairs.forEach((pair, idx) => {
        ['src', 'tgt'].forEach(side => {
            const textarea = document.getElementById(`editTextarea_${side}_${idx}`);
            if (textarea) {
                textarea.addEventListener('input', (e) => {
                    // 只更新状态值，不触发重新渲染
                    AppState.editValues[side] = e.target.value;
                    
                    // 关闭同义词弹窗但不重新渲染整个页面
                    if (AppState.synonymState.show) {
                        AppState.synonymState.show = false;
                        const popup = document.getElementById('synonymPopup');
                        if (popup) popup.remove();
                    }
                    
                    autoResizeTextarea(textarea);
                });
                textarea.addEventListener('mouseup', (e) => handleTextSelect(e, side, idx));
                autoResizeTextarea(textarea);
            }

            const refineInput = document.getElementById(`refineInput_${side}_${idx}`);
            if (refineInput) {
                refineInput.addEventListener('input', (e) => {
                    // 只更新状态，不触发渲染
                    AppState.refinePrompt = e.target.value;
                });
                refineInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        triggerCustomRefine(idx, side);
                    }
                });
            }
        });
    });

    // 全局点击（关闭菜单）
    document.removeEventListener('mousedown', globalClickHandler);
    document.addEventListener('mousedown', globalClickHandler);
}

function globalClickHandler(event) {
    const target = event.target;
    
    // 关闭同义词弹窗
    const synonymPopup = document.getElementById('synonymPopup');
    if (synonymPopup && !synonymPopup.contains(target)) {
        updateSynonymState({ show: false });
    }
    
    // 关闭设置弹窗（如果点击在弹窗外部）
    if (AppState.activeSettingsPopup !== null) {
        const popover = target.closest('.absolute.top-full');
        const settingsButton = target.closest('[onclick*="toggleSettingsPopup"]');
        if (!popover && !settingsButton) {
            closeSettingsPopup();
        }
    }
    
    // 关闭各种菜单
    if (AppState.showModelMenu && !target.closest('[onclick*="toggleModelMenu"]') && !target.closest('.absolute')) {
        AppState.showModelMenu = false;
        renderApp();
    }
    if (AppState.showHistoryMenu && !target.closest('[onclick*="toggleHistoryMenu"]') && !target.closest('.absolute')) {
        AppState.showHistoryMenu = false;
        renderApp();
    }
    if (AppState.showSaveMenu && !target.closest('[onclick*="toggleSaveMenu"]') && !target.closest('.absolute')) {
        AppState.showSaveMenu = false;
        renderApp();
    }
}

function autoResizeTextarea(textarea) {
    if (!textarea) return;
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// ============= 辅助UI函数 =============
function copySourceText(buttonElement) {
    const text = AppState.translationPairs.map(p => p.src).join('\n');
    copyToClipboard(text);
    showButtonFeedback(buttonElement);
}

function copyTargetText(buttonElement) {
    const text = AppState.translationPairs.map(p => p.tgt).join('\n');
    copyToClipboard(text);
    showButtonFeedback(buttonElement);
}

function saveGeminiApiKey(buttonElement) {
    const input = document.getElementById('geminiApiKeyInput');
    if (input) {
        AppState.geminiApiKey = input.value.trim();
        // 保存到localStorage
        try {
            localStorage.setItem('geminiApiKey', AppState.geminiApiKey);
        } catch (e) {}
        showSaveButtonFeedback(buttonElement);
    }
}

function toggleApiKeyVisibility(inputId) {
    const input = document.getElementById(inputId || 'geminiApiKeyInput');
    if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
    }
}

function saveOpenaiApiKey(buttonElement) {
    const input = document.getElementById('openaiApiKeyInput');
    if (input) {
        AppState.openaiApiKey = input.value.trim();
        // 保存到localStorage
        try {
            localStorage.setItem('openaiApiKey', AppState.openaiApiKey);
        } catch (e) {}
        showSaveButtonFeedback(buttonElement);
    }
}

function saveClaudeSettings(buttonElement) {
    const apiKeyInput = document.getElementById('claudeApiKeyInput');
    const proxyUrlInput = document.getElementById('claudeProxyUrlInput');

    if (apiKeyInput) {
        AppState.claudeApiKey = apiKeyInput.value.trim();
    }
    if (proxyUrlInput) {
        AppState.claudeProxyUrl = proxyUrlInput.value.trim();
    }

    // 保存到localStorage
    try {
        localStorage.setItem('claudeApiKey', AppState.claudeApiKey);
        localStorage.setItem('claudeProxyUrl', AppState.claudeProxyUrl);
    } catch (e) {}

    showSaveButtonFeedback(buttonElement);
}

function saveDeepseekApiKey(buttonElement) {
    const input = document.getElementById('deepseekApiKeyInput');
    if (input) {
        AppState.deepseekApiKey = input.value.trim();
        // 保存到localStorage
        try {
            localStorage.setItem('deepseekApiKey', AppState.deepseekApiKey);
        } catch (e) {}
        showSaveButtonFeedback(buttonElement);
    }
}

function toggleSaveMenu() {
    AppState.showSaveMenu = !AppState.showSaveMenu;
    AppState.showModelMenu = false;
    AppState.showHistoryMenu = false;
    renderApp();
}

function toggleHistoryMenu() {
    AppState.showHistoryMenu = !AppState.showHistoryMenu;
    AppState.showModelMenu = false;
    AppState.showSaveMenu = false;
    renderApp();
}

function toggleModelMenu() {
    AppState.showModelMenu = !AppState.showModelMenu;
    AppState.showHistoryMenu = false;
    AppState.showSaveMenu = false;
    renderApp();
}

function toggleAutoTranslate() {
    AppState.isAutoTranslate = !AppState.isAutoTranslate;
    renderApp();
}

function toggleAutoDetect() {
    AppState.isAutoDetect = !AppState.isAutoDetect;
    renderApp();
}

function toggleAutoSegment() {
    AppState.isAutoSegment = !AppState.isAutoSegment;
    // 保存到 localStorage
    try {
        localStorage.setItem('isAutoSegment', AppState.isAutoSegment.toString());
    } catch (e) {}
    renderApp();
}

function setAutoSaveInterval(ms) {
    AppState.autoSaveInterval = ms;
    AppState.showSaveMenu = false;
    // 保存到 localStorage
    try {
        localStorage.setItem('autoSaveInterval', ms.toString());
    } catch (e) {}
    renderApp();
}

function restoreHistoryItem(idx) {
    restoreGlobalHistory(AppState.globalHistory[idx]);
}

function selectModel(provider, modelId) {
    AppState.apiProvider = provider;
    AppState.selectedModel = modelId;
    AppState.showModelMenu = false;
    
    // 保存到 localStorage
    try {
        localStorage.setItem('apiProvider', provider);
        localStorage.setItem('selectedModel', modelId);
    } catch (e) {}
    
    renderApp();
}

function openLocalSettings() {
    AppState.showLocalSettings = true;
    AppState.showModelMenu = false;
    renderApp();
}

function openSettings() {
    AppState.showSettings = true;
    AppState.showModelMenu = false;
    renderApp();
}

function closeSettings() {
    AppState.showSettings = false;
    renderApp();
}

function toggleModelVisibility(modelId) {
    AppState.modelVisibility[modelId] = !AppState.modelVisibility[modelId];
    // 保存到 localStorage
    try {
        localStorage.setItem('modelVisibility', JSON.stringify(AppState.modelVisibility));
    } catch (e) {}
    renderApp();
}

function handleConnectLocalClick(buttonElement) {
    const input = document.getElementById('localUrlInput');
    if (input) {
        AppState.localBaseUrl = input.value;
        // 保存到 localStorage
        try {
            localStorage.setItem('localBaseUrl', AppState.localBaseUrl);
        } catch (e) {}
    }
    // 保存按钮引用以便在连接成功后显示反馈
    AppState._connectButtonElement = buttonElement;
    handleConnectLocal();
}

function setLanguage(src, tgt) {
    AppState.sourceLang = src;
    AppState.targetLang = tgt;
    AppState.isAutoDetect = false;
    renderApp();
}

function setViewMode(mode) {
    AppState.viewMode = mode;
    AppState.isEditingMode = (mode === 'edit');
    renderApp();
}

function swapLanguages() {
    const temp = AppState.sourceLang;
    AppState.sourceLang = AppState.targetLang;
    AppState.targetLang = temp;
    AppState.isAutoDetect = false;
    renderApp();
}

function triggerCustomRefine(idx, side) {
    if (AppState.refinePrompt.trim()) {
        handleAiRefine(idx, side, 'custom');
    }
}

function triggerSaveRowUpdate(idx) {
    saveRowUpdate(idx, AppState.editValues);
}

// ============= 设置弹窗控制 =============
function toggleSettingsPopup(type, idx, side) {
    if (AppState.activeSettingsPopup === type && AppState.activeSettingsIndex === idx && AppState.activeSettingsSide === side) {
        closeSettingsPopup();
    } else {
        AppState.activeSettingsPopup = type;
        AppState.activeSettingsIndex = idx;
        AppState.activeSettingsSide = side;
        renderApp();
    }
}

function closeSettingsPopup() {
    AppState.activeSettingsPopup = null;
    AppState.activeSettingsIndex = null;
    AppState.activeSettingsSide = null;
    renderApp();
}

function saveCustomPrompt(type) {
    const textarea = document.getElementById(`customPromptTextarea_${type}`);
    if (textarea) {
        AppState.customPrompts[type] = textarea.value.trim();
        // 保存到 localStorage
        try {
            localStorage.setItem('customPrompts', JSON.stringify(AppState.customPrompts));
        } catch (e) {}
    }
    closeSettingsPopup();
}

function resetPromptToDefault(type) {
    AppState.customPrompts[type] = '';
    // 更新 localStorage
    try {
        localStorage.setItem('customPrompts', JSON.stringify(AppState.customPrompts));
    } catch (e) {}
    renderApp();
}

// ============= History Limit 设置 =============
function setHistoryLimit(limit) {
    AppState.historyLimit = limit;
    // 裁剪历史记录
    if (AppState.globalHistory.length > limit) {
        AppState.globalHistory = AppState.globalHistory.slice(0, limit);
    }
    // 保存到 localStorage
    try {
        localStorage.setItem('historyLimit', limit.toString());
    } catch (e) {}
    renderApp();
}

function setHistoryLimitCustom(value) {
    const limit = Math.max(1, parseInt(value) || 5);
    setHistoryLimit(limit);
}

// ============= Auto-Save 自定义设置 =============
function applyCustomAutoSave() {
    const input = document.getElementById('customAutoSaveInput');
    if (input) {
        const val = parseInt(input.value);
        if (val > 0) {
            setAutoSaveInterval(val * 60 * 1000);
        }
    }
}

// ============= 初始化 =============
document.addEventListener('DOMContentLoaded', function() {
    // 加载保存的设置
    loadSavedSettings();

    // 初始渲染不需要保留滚动位置
    renderApp(false);

    // 全局点击事件 - 点击空白区域退出编辑模式
    document.addEventListener('click', handleGlobalClick);

    // 自动保存定时器
    setInterval(function() {
        if (AppState.autoSaveInterval > 0 && AppState.translationPairs.length > 0) {
            addToGlobalHistory(AppState.translationPairs, AppState.sessionId);
        }
    }, AppState.autoSaveInterval);

    // 自动翻译防抖（在handleInputChange中处理）
});

// 加载所有保存的设置
function loadSavedSettings() {
    try {
        // 加载 Gemini API Key
        const savedKey = localStorage.getItem('geminiApiKey');
        if (savedKey) {
            AppState.geminiApiKey = savedKey;
        }

        // 加载 OpenAI API Key
        const savedOpenaiKey = localStorage.getItem('openaiApiKey');
        if (savedOpenaiKey) {
            AppState.openaiApiKey = savedOpenaiKey;
        }

        // 加载 Claude API Key
        const savedClaudeKey = localStorage.getItem('claudeApiKey');
        if (savedClaudeKey) {
            AppState.claudeApiKey = savedClaudeKey;
        }

        // 加载 Claude Proxy URL
        const savedClaudeProxyUrl = localStorage.getItem('claudeProxyUrl');
        if (savedClaudeProxyUrl) {
            AppState.claudeProxyUrl = savedClaudeProxyUrl;
        }

        // 加载 DeepSeek API Key
        const savedDeepseekKey = localStorage.getItem('deepseekApiKey');
        if (savedDeepseekKey) {
            AppState.deepseekApiKey = savedDeepseekKey;
        }

        // 加载 Local Base URL
        const savedLocalUrl = localStorage.getItem('localBaseUrl');
        if (savedLocalUrl) {
            AppState.localBaseUrl = savedLocalUrl;
        }
        
        // 加载 History Limit
        const savedHistoryLimit = localStorage.getItem('historyLimit');
        if (savedHistoryLimit) {
            AppState.historyLimit = parseInt(savedHistoryLimit) || 5;
        }
        
        // 加载 Auto-Save Interval
        const savedAutoSaveInterval = localStorage.getItem('autoSaveInterval');
        if (savedAutoSaveInterval) {
            AppState.autoSaveInterval = parseInt(savedAutoSaveInterval) || 5 * 60 * 1000;
        }
        
        // 加载 Custom Prompts
        const savedCustomPrompts = localStorage.getItem('customPrompts');
        if (savedCustomPrompts) {
            try {
                const parsed = JSON.parse(savedCustomPrompts);
                AppState.customPrompts = { ...AppState.customPrompts, ...parsed };
            } catch (e) {}
        }
        
        // 加载上次使用的 API Provider 和模型
        const savedApiProvider = localStorage.getItem('apiProvider');
        const savedSelectedModel = localStorage.getItem('selectedModel');
        if (savedApiProvider) {
            AppState.apiProvider = savedApiProvider;
        }
        if (savedSelectedModel) {
            AppState.selectedModel = savedSelectedModel;
        }

        // 加载 Model Visibility 设置
        const savedModelVisibility = localStorage.getItem('modelVisibility');
        if (savedModelVisibility) {
            try {
                const parsed = JSON.parse(savedModelVisibility);
                AppState.modelVisibility = { ...AppState.modelVisibility, ...parsed };
            } catch (e) {}
        }

        // 加载自动分段设置
        const savedAutoSegment = localStorage.getItem('isAutoSegment');
        if (savedAutoSegment !== null) {
            AppState.isAutoSegment = savedAutoSegment === 'true';
        }

        // 只要有保存的本地地址，就自动尝试连接（获取模型列表）
        if (savedLocalUrl) {
            autoConnectLocal();
        }
    } catch (e) {
        console.warn('Failed to load saved settings:', e);
    }
}

// 自动连接本地 LM Studio（获取模型列表，失败时显示错误提示）
async function autoConnectLocal() {
    try {
        const models = await fetchLocalModels(AppState.localBaseUrl);
        AppState.localModels = models;
        
        // 如果上次使用的是本地模型，检查是否仍然可用
        if (AppState.apiProvider === 'local') {
            const savedModel = localStorage.getItem('selectedModel');
            if (savedModel && models.some(m => m.id === savedModel)) {
                AppState.selectedModel = savedModel;
            } else if (models.length > 0) {
                AppState.selectedModel = models[0].id;
            }
        }
        
        console.log('Auto-connected to local LM Studio:', AppState.localBaseUrl, 'Models:', models.length);
        renderApp();
    } catch (e) {
        // 显示错误提示
        console.warn('Auto-connect to local LM Studio failed:', e.message);
        AppState.localModels = [];
        
        // 如果上次使用的是本地模型但现在连接失败，回退到 Gemini
        if (AppState.apiProvider === 'local') {
            AppState.apiProvider = 'gemini';
            AppState.selectedModel = 'gemini-2.5-flash-lite';
        }
        
        // 显示顶部错误提示
        setState({ error: `无法连接到本地服务器 ${AppState.localBaseUrl}。请确保 LM Studio 正在运行。` });
    }
}

</script>
</body>
</html>
